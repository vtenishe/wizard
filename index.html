<!DOCTYPE html>
<!-- =============================================================================
FILE:    index.html
PROJECT: AMPS v2025 ‚Äî SEP/GCR Transport ‚Äî CCMC Runs-on-Request Web Wizard
PURPOSE: Modular, production-ready wizard UI for configuring a runs-on-request
         AMPS SEP/GCR transport simulation. Provides 10-step workflow with
         validation, dynamic diagrams (boundary geometry, etc.), and a generated
         AMPS_PARAM.in preview for submission.

NOTES / IMPLEMENTATION DETAILS
- This is the modular build: styles are in /css and logic is in /js (loaded in
  numeric order).
- Step navigation is driven by js/02-wizard.js (goStep / wizClick). Panels are
  pre-rendered in the HTML and shown/hidden via CSS classes.
- The Boundary step (Step 4) is implemented inline in this file and wired to
  js/04-boundary.js (BOX vs SHUE, auto/manual Shue controls, SVG diagram).
- The "panel_boundary.html" and "panel_temporal.html" files are legacy/development
  artifacts and are not included at runtime by default (see their headers).

FIXES APPLIED IN THIS PACKAGE (2026-02-20)
- Removed an accidental duplicate <body> tag (HTML validity / DOM stability).
- Made the step indicator strip clickable (and keyboard accessible) by wiring
  each step to wizClick(n).

ADDITIONAL UPDATES (2026-02-20): "Bkg B-Field" correctness + documentation
- Replaced placeholder/legacy field-model labels with a consistent set of
  Tsyganenko-family external-field options that match typical CCMC/GEOPACK
  naming: TS05, TS04, T96, T01, TS07D, TA15.
- Preserved physics-based background-field workflows via uploaded MHD output:
  BATSRUS and GAMERA.
- Implemented model-specific "Driving Parameters" forms that reflect how each
  model is normally driven (scalar drivers for T96/T01; coefficient selection
  for TS07D; GOES |B| requirement for TA15).
- Added example quiet/storm presets (order-of-magnitude) in the TS05/TS04
  driving-parameter section to guide users and improve reproducibility.

MAINTAINER NOTE
- If you change any field-model keyword labels here, update the corresponding
  logic/state in js/01-state.js and js/03-bgfield.js.
============================================================================= -->

<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>AMPS v2025 &mdash; SEP/GCR Transport &mdash; CCMC Runs-on-Request</title>




<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet"/>
<!-- Design tokens (CSS custom properties) ‚Äî must be first -->
<link rel="stylesheet" href="css/01-tokens.css"/>
<!-- Page layout: topbar, header, wizard strip, two-column grid, sections -->
<link rel="stylesheet" href="css/02-layout.css"/>
<!-- Reusable UI components: fields, cards, toggles, badges, KW strip -->
<link rel="stylesheet" href="css/03-components.css"/>
<!-- SVG/canvas diagram styles: boundary cross-sections, efield, spectrum -->
<link rel="stylesheet" href="css/04-diagrams.css"/>
</head>
<body>
<div class="topbar">
  <div class="tb-nasa">AMPS</div><div class="tb-sep">|</div>
  <div class="tb-title"><b>Adaptive Mesh Particle Simulator</b> &mdash; Runs-on-Request</div>
  <div class="tb-right">
    <a class="tb-link" href="#">Model Catalog</a>
    <a class="tb-link" href="#">My Runs</a>
    <!--
      DOCS MENU (NEW)
      --------------
      A topbar dropdown that mirrors the look-and-feel and interaction
      conventions of the Help menu. Each entry opens a PDF in a new tab.

      PDFs live in:          doc/*.pdf
      LaTeX sources live in: doc/latex/*.tex

      NOTE: Links are relative so the site remains deployable as a static
      bundle at CCMC or on any web server.
    -->
    <div class="docs-dropdown">
      <a class="tb-link docs-trigger" id="docs-trigger" href="#">Docs <span id="docs-arrow">‚ñº</span></a>
      <div class="help-menu" id="docs-main-menu" style="display:none;">

        <!-- Level 1: Main Categories (collapsible) -->
        <div class="help-section">
          <div class="help-section-header" data-docs-toggle="section" data-target="docs-overview">
            <span class="help-label">How Calculations Are Done</span>
            <span class="help-toggle" id="docs-arrow-docs-overview">‚ñ∂</span>
          </div>
          <div class="help-section-content" id="docs-content-docs-overview" style="display:none;">
            <div class="help-detail-panel">
              <ul>
                <li><a href="doc/overview_calculation_pipeline.pdf">Pipeline overview: rigidity cutoffs, flux evaluation, and spectrum reconstruction</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="help-section">
          <div class="help-section-header" data-docs-toggle="section" data-target="docs-cutoffs">
            <span class="help-label">Cutoff Rigidity</span>
            <span class="help-toggle" id="docs-arrow-docs-cutoffs">‚ñ∂</span>
          </div>
          <div class="help-section-content" id="docs-content-docs-cutoffs" style="display:none;">
            <div class="help-detail-panel">
              <ul>
                <li><a href="doc/cutoff_rigidity.pdf">Geomagnetic cutoff rigidity: definitions, penumbra, and numerical backtracing</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="help-section">
          <div class="help-section-header" data-docs-toggle="section" data-target="docs-flux">
            <span class="help-label">Flux and Spectra</span>
            <span class="help-toggle" id="docs-arrow-docs-flux">‚ñ∂</span>
          </div>
          <div class="help-section-content" id="docs-content-docs-flux" style="display:none;">
            <div class="help-detail-panel">
              <ul>
                <li><a href="doc/flux_and_spectrum_definitions.pdf">Flux, differential intensity, and unit conventions used by AMPS</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="help-section">
          <div class="help-section-header" data-docs-toggle="section" data-target="docs-goes">
            <span class="help-label">GOES-18/19 Spectrum Reconstruction</span>
            <span class="help-toggle" id="docs-arrow-docs-goes">‚ñ∂</span>
          </div>
          <div class="help-section-content" id="docs-content-docs-goes" style="display:none;">
            <div class="help-detail-panel">
              <ul>
                <li><a href="doc/goes18_19_spectrum_reconstruction.pdf">Reconstructing differential spectra from GOES-18/19 proton channels</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="help-section">
          <div class="help-section-header" data-docs-toggle="section" data-target="docs-fields">
            <span class="help-label">Electric &amp; Magnetic Field Models</span>
            <span class="help-toggle" id="docs-arrow-docs-fields">‚ñ∂</span>
          </div>
          <div class="help-section-content" id="docs-content-docs-fields" style="display:none;">
            <div class="help-detail-panel">
              <ul>
                <li><a href="doc/electric_field_models.pdf">Electric field models: corotation, Volland‚ÄìStern, Weimer, and inductive dB/dt</a></li>
                <li><a href="doc/magnetic_field_models.pdf">Magnetic field models: T96/T15, IGRF, and MHD-driven fields</a></li>
              </ul>
            </div>
          </div>
        </div>

      </div>
    </div>
    <div class="help-dropdown">
      <a class="tb-link help-trigger" id="help-trigger" href="#">Help <span id="help-arrow">‚ñº</span></a>
      <div class="help-menu" id="help-main-menu" style="display:none;">
        <!-- Level 1: Main Categories -->
        <div class="help-section">
          <div class="help-section-header" data-help-toggle="section" data-target="physics-models">
            <span class="help-label">Physics Models</span>
            <span class="help-toggle" id="arrow-physics-models">‚ñ∂</span>
          </div>
          <div class="help-section-content" id="content-physics-models" style="display:none;">
            <!-- Level 2: Physics Model Categories -->
            <div class="help-subsection">
              <div class="help-subsection-header" data-help-toggle="subsection" data-target="electric-field">
                <span class="help-sublabel">Background Electric Field</span>
                <span class="help-toggle" id="arrow-electric-field">‚ñ∂</span>
              </div>
              <div class="help-subsection-content" id="content-electric-field" style="display:none;">
                <!-- Level 3: Detailed Content -->
                <div class="help-detail-panel">
                  <h4>Electric Field Models</h4>
                  
                  <div class="model-section">
                    <h5>Corotation Electric Field</h5>
                    <p><strong>Physics:</strong> Earth's rotation-induced electric field in the magnetosphere.</p>
                    <p><strong>Formula:</strong> <code>E = -(œâ √ó r) √ó B</code></p>
                    <p>where œâ is Earth's angular velocity (7.292√ó10‚Åª‚Åµ rad/s), r is position vector, B is magnetic field.</p>
                    <p><strong>Reference:</strong> Volland, H. (1973). "A semiempirical model of large-scale magnetospheric electric fields." <em>J. Geophys. Res.</em>, 78(1), 171-180.</p>
                  </div>

                  <div class="model-section">
                    <h5>Volland-Stern Convection Model</h5>
                    <p><strong>Physics:</strong> Empirical model of magnetospheric convection driven by solar wind interaction.</p>
                    <p><strong>Formula:</strong> <code>Œ¶(r,Œ∏) = A¬∑r^Œ≥¬∑sin(Œ∏)</code></p>
                    <p><strong>Parameters:</strong></p>
                    <ul>
                      <li><strong>Kp:</strong> Geomagnetic activity index (0-9). Higher Kp = stronger convection.</li>
                      <li><strong>Œ≥ (gamma):</strong> Shielding exponent (typical: 2.0; range: 1.5-3.0). Controls radial dependence.</li>
                      <li><strong>A:</strong> Intensity coefficient derived from Kp via Maynard & Chen (1975) relation.</li>
                    </ul>
                    <p><strong>References:</strong></p>
                    <ul>
                      <li>Volland, H. (1973). "A semiempirical model of large-scale magnetospheric electric fields." <em>J. Geophys. Res.</em>, 78(1), 171-180.</li>
                      <li>Stern, D. P. (1975). "The motion of a proton in the equatorial magnetosphere." <em>J. Geophys. Res.</em>, 80(4), 595-599.</li>
                      <li>Maynard, N. C., & Chen, A. J. (1975). "Isolated cold plasma regions: Observations and their relation to possible production mechanisms." <em>J. Geophys. Res.</em>, 80(7), 1009-1013.</li>
                    </ul>
                  </div>

                  <div class="model-section">
                    <h5>Weimer 2005 Model</h5>
                    <p><strong>Physics:</strong> Data-driven empirical model based on satellite electric field measurements.</p>
                    <p><strong>Inputs:</strong> IMF By, Bz, solar wind velocity, dipole tilt angle.</p>
                    <p><strong>Coverage:</strong> High-latitude ionospheric electric potential mapped to magnetosphere.</p>
                    <p><strong>Reference:</strong> Weimer, D. R. (2005). "Improved ionospheric electrodynamic models and application to calculating Joule heating rates." <em>J. Geophys. Res.</em>, 110(A5), A05306. doi:10.1029/2004JA010884</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="help-subsection">
              <div class="help-subsection-header" data-help-toggle="subsection" data-target="magnetic-field">
                <span class="help-sublabel">Background Magnetic Field</span>
                <span class="help-toggle" id="arrow-magnetic-field">‚ñ∂</span>
              </div>
              <div class="help-subsection-content" id="content-magnetic-field" style="display:none;">
                <div class="help-detail-panel">
                  <h4>Magnetic Field Models</h4>
                  
                  <div class="model-section">
                    <h5>TS05 (Tsyganenko 2005)</h5>
                    <p><strong>Type:</strong> Storm-time empirical model with realistic tail current dynamics.</p>
                    <p><strong>Driving Parameters:</strong></p>
                    <ul>
                      <li><strong>Dst:</strong> Disturbance storm-time index [nT]. Proxy for ring current intensity. Typical range: +50 (quiet) to -600 (extreme storm).</li>
                      <li><strong>Pdyn:</strong> Solar wind dynamic pressure [nPa]. Typical: 1-5 nPa (quiet), 5-20 nPa (storm).</li>
                      <li><strong>IMF By, Bz:</strong> Interplanetary magnetic field components [nT, GSM]. Control magnetopause shape and tail configuration.</li>
                      <li><strong>Vx:</strong> Solar wind velocity [km/s, GSM]. Typical: 300-800 km/s.</li>
                      <li><strong>Nsw:</strong> Solar wind proton density [cm‚Åª¬≥]. Typical: 1-30 cm‚Åª¬≥.</li>
                    </ul>
                    <p><strong>Applications:</strong> SEP event modeling, radiation belt dynamics, geomagnetic storm studies.</p>
                    <p><strong>Reference:</strong> Tsyganenko, N. A., & Sitnov, M. I. (2005). "Modeling the dynamics of the inner magnetosphere during strong geomagnetic storms." <em>J. Geophys. Res.</em>, 110(A3), A03208. doi:10.1029/2004JA010798</p>
                  </div>

                  <div class="model-section">
                    <h5>T96 (Tsyganenko 1996)</h5>
                    <p><strong>Type:</strong> Widely-used empirical model with dipole tilt dependence.</p>
                    <p><strong>Driving Parameters:</strong> Dst, Pdyn, IMF By, Bz, dipole tilt angle.</p>
                    <p><strong>Strengths:</strong> Computationally efficient, good for statistical studies.</p>
                    <p><strong>Limitations:</strong> Less accurate during extreme storms compared to TS05.</p>
                    <p><strong>Reference:</strong> Tsyganenko, N. A. (1995). "Modeling the Earth's magnetospheric magnetic field confined within a realistic magnetopause." <em>J. Geophys. Res.</em>, 100(A4), 5599-5612. (Updated in 1996)</p>
                  </div>

                  <div class="model-section">
                    <h5>T01 (Tsyganenko 2001)</h5>
                    <p><strong>Type:</strong> Storm-time model with substorm dynamics.</p>
                    <p><strong>Driving Parameters:</strong> Similar to T96, plus substorm indices.</p>
                    <p><strong>Reference:</strong> Tsyganenko, N. A. (2002). "A model of the near magnetosphere with a dawn-dusk asymmetry: 1. Mathematical structure." <em>J. Geophys. Res.</em>, 107(A8), 1179. doi:10.1029/2001JA000219</p>
                  </div>

                  <div class="model-section">
                    <h5>TS07D (Tsyganenko 2007 Data-Based)</h5>
                    <p><strong>Type:</strong> Data-assimilative model with time-dependent coefficients.</p>
                    <p><strong>Inputs:</strong> Pre-computed coefficient files from OMNI database or user upload.</p>
                    <p><strong>Advantage:</strong> Best accuracy for historical event reconstruction.</p>
                    <p><strong>Reference:</strong> Tsyganenko, N. A., & Sitnov, M. I. (2007). "Magnetospheric configurations from a high-resolution data-based magnetic field model." <em>J. Geophys. Res.</em>, 112(A6), A06225. doi:10.1029/2007JA012260</p>
                  </div>

                  <div class="model-section">
                    <h5>TA15 (Tsyganenko-Andreeva 2015)</h5>
                    <p><strong>Type:</strong> Latest empirical model with improved ring current representation.</p>
                    <p><strong>Additional Parameter:</strong> GOES total magnetic field magnitude [nT].</p>
                    <p><strong>Improvements:</strong> Better accuracy in inner magnetosphere (L < 6.6).</p>
                    <p><strong>Reference:</strong> Tsyganenko, N. A., & Andreeva, V. A. (2015). "A forecasting model of the magnetosphere driven by an optimal solar wind coupling function." <em>J. Geophys. Res. Space Physics</em>, 120, 8401-8425. doi:10.1002/2015JA021641</p>
                  </div>

                  <div class="model-section">
                    <h5>MHD Models (BATS-R-US, GAMERA)</h5>
                    <p><strong>Type:</strong> Physics-based magnetohydrodynamic simulations.</p>
                    <p><strong>Input:</strong> Time-dependent 3D magnetic field from uploaded MHD output files.</p>
                    <p><strong>Advantages:</strong> Self-consistent physics, captures non-linear dynamics.</p>
                    <p><strong>Computational Cost:</strong> High (typically 10√ó empirical models).</p>
                    <p><strong>References:</strong></p>
                    <ul>
                      <li>BATS-R-US: T√≥th, G., et al. (2012). "Adaptive numerical algorithms in space weather modeling." <em>J. Comput. Phys.</em>, 231(3), 870-903.</li>
                      <li>GAMERA: Zhang, B., et al. (2019). "GAMERA: A three-dimensional finite-volume MHD solver for non-orthogonal curvilinear geometries." <em>Astrophys. J. Suppl. Ser.</em>, 244(1), 20.</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            
<div class="help-subsection">
  <div class="help-subsection-header" data-help-toggle="subsection" data-target="particle-spectrum-models">
    <span class="help-sublabel">Particle Spectrum Models</span>
    <span class="help-toggle" id="arrow-particle-spectrum-models">‚ñ∂</span>
  </div>
  <div class="help-subsection-content" id="content-particle-spectrum-models" style="display:none;">
    <div class="help-detail-panel">
      <h4>Particle Source Spectrum Models</h4>

      <div class="infobox info-blue" style="margin:0 0 10px 0;">
        <b>What the code expects:</b> all options define the <b>differential</b> flux
        <code>dJ/dE</code> as a function of kinetic energy per nucleon <code>E</code>.
        In this wizard: <code>E</code> in <b>MeV/n</b>, <code>dJ/dE</code> in <b>p/cm¬≤/s/sr/(MeV/n)</b>.
        This choice maps to the <code>#SPECTRUM</code> section in <code>AMPS_PARAM.in</code>.
      </div>

      <div class="model-section">
        <h5>POWER_LAW</h5>
        <p><strong>Use:</strong> fast parameter studies and many SEP events when a single slope is adequate.</p>
        <p><strong>Form:</strong> <code>J(E) = J0 ¬∑ (E/E0)<sup>-Œ≥</sup></code></p>
        <p><strong>Parameters:</strong> J0 (normalization), Œ≥ (spectral index), E0 (pivot).</p>
        <p><strong>Typical:</strong> SEP Œ≥ ‚âà 2‚Äì5.</p>
      </div>

      <div class="model-section">
        <h5>POWER_LAW_CUTOFF</h5>
        <p><strong>Use:</strong> SEP spectra with a finite high-energy extent.</p>
        <p><strong>Form:</strong> <code>J(E) = J0 ¬∑ (E/E0)<sup>-Œ≥</sup> ¬∑ exp(-E/Ec)</code></p>
        <p><strong>Parameters:</strong> J0, Œ≥, E0, Ec (cutoff).</p>
      </div>

      <div class="model-section">
        <h5>LIS_FORCE_FIELD</h5>
        <p><strong>Use:</strong> Galactic Cosmic Ray (GCR) background with solar-cycle modulation.</p>
        <p><strong>Physics:</strong> force-field approximation with modulation potential Œ¶.</p>
        <p><strong>Reference:</strong> Gleeson, L. J., & Axford, W. I. (1968). <em>ApJ</em>, 154, 1011.</p>
      </div>

      <div class="model-section">
        <h5>BAND</h5>
        <p><strong>Use:</strong> spectra with curvature / break (softening above a characteristic energy).</p>
        <p><strong>Idea:</strong> two slopes joined around a break energy E0 (Œ≥1 below, Œ≥2 above).</p>
        <p><strong>Reference:</strong> Band, D., et al. (1993). <em>ApJ</em>, 413, 281‚Äì292.</p>
      </div>

      <div class="model-section">
        <h5>TABLE</h5>
        <p><strong>Use:</strong> event realism when you have measured spectra (e.g., GOES).</p>
        <p><strong>Input:</strong> 2-column ASCII table <code>E  dJ/dE</code> (E in MeV/n).</p>
        <p><strong>Notes:</strong> ensure the table covers the run‚Äôs Emin‚ÄìEmax; interpolation is used between points.</p>
      </div>
    </div>
  </div>
</div>

<div class="help-subsection">
              <div class="help-subsection-header" data-help-toggle="subsection" data-target="boundary-models">
                <span class="help-sublabel">Boundary Models</span>
                <span class="help-toggle" id="arrow-boundary-models">‚ñ∂</span>
              </div>
              <div class="help-subsection-content" id="content-boundary-models" style="display:none;">
                <div class="help-detail-panel">
                  <h4>Domain Boundary Models</h4>
                  
                  <div class="model-section">
                    <h5>BOX Boundary</h5>
                    <p><strong>Geometry:</strong> Rectangular domain in GSM coordinates.</p>
                    <p><strong>Parameters:</strong></p>
                    <ul>
                      <li><strong>X_max, X_min:</strong> Sunward/tailward extent [RE]. Typical: +15 to -60 RE.</li>
                      <li><strong>Y_max, Y_min:</strong> Dawn/dusk extent [RE]. Typical: ¬±20-30 RE.</li>
                      <li><strong>Z_max, Z_min:</strong> North/south extent [RE]. Typical: ¬±15-25 RE.</li>
                      <li><strong>R_inner:</strong> Inner boundary radius [RE]. Typical: 2.0 RE (above ionosphere).</li>
                    </ul>
                    <p><strong>Use Cases:</strong> Full magnetotail studies, large-scale transport, computational simplicity.</p>
                    <p><strong>Advantages:</strong> Simple geometry, easy to configure, no empirical dependencies.</p>
                  </div>

                  <div class="model-section">
                    <h5>Shue 1998 Magnetopause Model</h5>
                    <p><strong>Geometry:</strong> Empirical magnetopause surface that adapts to solar wind conditions.</p>
                    <p><strong>Formula:</strong> <code>r(Œ∏) = r‚ÇÄ¬∑(2/(1+cos(Œ∏)))^Œ±</code></p>
                    <p><strong>Parameters:</strong></p>
                    <ul>
                      <li><strong>r‚ÇÄ:</strong> Subsolar standoff distance [RE]. Derived from Pdyn and Bz, or user-specified. Typical: 8-12 RE.</li>
                      <li><strong>Œ± (alpha):</strong> Flaring parameter. Controls day-night asymmetry. Typical: 0.5-0.8.</li>
                      <li><strong>X_tail:</strong> Nightside tail cutoff [RE]. Typical: -60 RE.</li>
                    </ul>
                    <p><strong>Auto Mode:</strong> r‚ÇÄ and Œ± computed from TS05 drivers using Shue et al. empirical relations:</p>
                    <ul>
                      <li>r‚ÇÄ = (10.22 + 1.29¬∑tanh(0.184¬∑(Bz+8.14)))¬∑Pdyn^(-1/6.6)</li>
                      <li>Œ± = (0.58 - 0.007¬∑Bz)¬∑(1 + 0.024¬∑log(Pdyn))</li>
                    </ul>
                    <p><strong>Use Cases:</strong> Near-Earth SEP events, realistic magnetopause geometry, storm-time compression studies.</p>
                    <p><strong>Reference:</strong> Shue, J.-H., et al. (1998). "Magnetopause location under extreme solar wind conditions." <em>J. Geophys. Res.</em>, 103(A8), 17,691-17,700. doi:10.1029/98JA01103</p>
                  </div>

                  <div class="model-section">
                    <h5>Inner Boundary (Loss Cone)</h5>
                    <p><strong>Physics:</strong> Particles crossing the inner boundary are assumed lost to atmospheric precipitation.</p>
                    <p><strong>Typical Radius:</strong> 2.0 RE (‚âà650 km altitude). Below this, particle gyroradii become comparable to field-line curvature.</p>
                    <p><strong>Implementation:</strong> Particles that reach r < R_inner are removed from simulation.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="help-section">
          <div class="help-section-header" data-help-toggle="section" data-target="input-files">
            <span class="help-label">Input Files</span>
            <span class="help-toggle" id="arrow-input-files">‚ñ∂</span>
          </div>
          <div class="help-section-content" id="content-input-files" style="display:none;">
            <div class="help-detail-panel">
              <h4>Input File Formats</h4>
              
              <div class="model-section">
                <h5>Trajectory File</h5>
                <p><strong>Format:</strong> NAIRAS Gregorian (9 columns) or MJD (4 columns)</p>
                <p><strong>Columns (Gregorian):</strong></p>
                <code style="display:block;background:#0a1628;padding:8px;margin:8px 0;font-size:11px;">
YYYY MM DD HH mm ss.s Lat[deg] Lon[deg] Alt[km]
                </code>
                <p><strong>Requirements:</strong> Monotonic timestamps, overlaps simulation time window, altitude > 100 km.</p>
                <p><strong>Example:</strong> VanAllenProbeA_Sep2017_trajectory.txt</p>
              </div>

              <div class="model-section">
                <h5>TS05 Driving Parameter File</h5>
                <p><strong>Format:</strong> Time-series of solar wind and geomagnetic indices</p>
                <p><strong>Columns:</strong> DateTime, Dst[nT], Pdyn[nPa], Bz[nT], Vx[km/s], Nsw[cm‚Åª¬≥], By[nT], Bx[nT]</p>
                <p><strong>Source:</strong> Auto-fetch from OMNIWeb or user upload</p>
                <p><strong>Cadence:</strong> Typically 1-minute or 5-minute resolution</p>
              </div>

              <div class="model-section">
                <h5>Spectrum Table File</h5>
                <p><strong>Format:</strong> Two-column ASCII</p>
                <code style="display:block;background:#0a1628;padding:8px;margin:8px 0;font-size:11px;">
E[MeV/n]    dJ/dE[particles/cm¬≤/s/sr/(MeV/n)]
1.0         10000.0
10.0        1000.0
100.0       100.0
                </code>
                <p><strong>Requirements:</strong> Energy range must span [E_min, E_max], minimum 5 data points</p>
              </div>
            </div>
          </div>
        </div>

        <div class="help-section">
          <div class="help-section-header" data-help-toggle="section" data-target="model-parameters">
            <span class="help-label">Model Parameters</span>
            <span class="help-toggle" id="arrow-model-parameters">‚ñ∂</span>
          </div>
          <div class="help-section-content" id="content-model-parameters" style="display:none;">
            <div class="help-detail-panel">
              <h4>Key AMPS Parameters</h4>
              
              <div class="model-section">
                <h5>Temporal Parameters</h5>
                <p><strong>FIELD_UPDATE_DT:</strong> Magnetic/electric field refresh interval [minutes]. Typical: 1-5 min during storms, 10-30 min for quiet times.</p>
                <p><strong>INJECT_DT:</strong> Particle injection cadence [minutes]. Must be ‚â• FIELD_UPDATE_DT. Typical: 5-60 min.</p>
                <p><strong>FLUX_DT:</strong> Output flux computation interval [minutes]. Typical: 1 min (matches satellite data cadence).</p>
              </div>

              <div class="model-section">
                <h5>Numerical Parameters</h5>
                <p><strong>N_PARTICLES:</strong> Test particles per injection batch. Typical: 10,000 (balance accuracy vs speed).</p>
                <p><strong>DT_TRACE:</strong> Integration timestep [seconds]. Typical: 0.1-1.0 s. Smaller = more accurate but slower.</p>
                <p><strong>MAX_BOUNCE:</strong> Maximum mirror bounces before termination. Typical: 500 (captures ~10 drift orbits).</p>
              </div>

              <div class="model-section">
                <h5>Energy Bins</h5>
                <p><strong>Purpose:</strong> Discrete energies at which flux is computed and output.</p>
                <p><strong>SEP Standard:</strong> [1, 5, 10, 30, 100, 300, 1000] MeV/n</p>
                <p><strong>GCR Extended:</strong> [10, 30, 100, 300, 1000, 3000, 10000] MeV/n</p>
                <p><strong>Considerations:</strong> More bins = larger output files. Spacing should match instrument response functions.</p>
              </div>
            
              <div class="model-section">
                <h5>Spectrum Models (Step 7)</h5>
                <p><strong>All spectrum options expect differential flux dJ/dE</strong> in <code>p/cm¬≤/s/sr/(MeV/n)</code> as a function of kinetic energy per nucleon <code>E</code> in <code>MeV/n</code>.</p>

                <p><strong>POWER_LAW:</strong> <code>J(E)=J‚ÇÄ¬∑(E/E‚ÇÄ)^(‚àíŒ≥)</code>. Use for basic SEP injections and quick sensitivity studies. Typical SEP Œ≥ ‚âà 2‚Äì5, pivot E‚ÇÄ often 10 MeV/n.</p>

                <p><strong>POWER_LAW_CUTOFF:</strong> <code>J(E)=J‚ÇÄ¬∑(E/E‚ÇÄ)^(‚àíŒ≥)¬∑exp(‚àíE/Ec)</code>. Adds a high-energy roll-off (finite acceleration limit). Typical Ec ‚âà 200‚Äì1000 MeV/n for large gradual SEP events.</p>

                <p><strong>LIS_FORCE_FIELD:</strong> Galactic Cosmic Ray baseline using a Local Interstellar Spectrum (LIS) with Gleeson‚ÄìAxford force-field modulation parameter <code>Œ¶</code> [MV]. Use for GCR background and solar-cycle dependence (Œ¶ ~ 400‚Äì700 MV near solar minimum; Œ¶ ~ 1000‚Äì1400 MV near solar maximum).</p>

                <p><strong>BAND:</strong> Band (1993)-style broken power law with a smooth transition. In this interface the break energy is derived from the two slopes (see preview formula in the Spectrum panel). Use for large SEP events where spectra soften above a characteristic energy.</p>

                <p><strong>TABLE:</strong> Measured spectrum from a two-column ASCII file <code>E[MeV/n]  dJ/dE</code>. Minimum 5 points. The uploaded range should cover your selected <code>Emin</code>‚Äì<code>Emax</code>. Recommended for event studies using GOES/other instrument-derived spectra.</p>
              </div>
</div>
          </div>
        </div>

        <div class="help-section help-link-section">
          <a href="#" class="help-link">
            <span class="help-label">CCMC Model Documentation</span>
            <span class="help-external">‚Üó</span>
          </a>
        </div>
        
        <div class="help-section help-link-section">
          <a href="#" class="help-link" href="mailto:amps-support@ccmc.gsfc.nasa.gov">
            <span class="help-label">Contact Support</span>
          </a>
        </div>
      </div>
    </div>
    <div class="tb-divider"></div>
    <div class="tb-badge">AMPS v2025</div>
  </div>
</div>
<div class="page-hd"><div class="page-hd-inner">
  <div class="model-chip"><div class="pulse"></div>AMPS v2025 &mdash; SEP &amp; GCR Transport Model &mdash; ISFM Extension</div>
  <h1>Simulation Setup &mdash; Runs-on-Request Submission Wizard</h1>
  <p>Configure your AMPS run: particle species, TS05 background field, domain boundary (BOX or Shue 1998 magnetopause), temporal variability, particle source spectrum, and output domain.
  All inputs generate <code style="background:rgba(26,136,212,.15);padding:1px 5px;border-radius:3px;color:#38c0ff;font-family:monospace;">AMPS_PARAM.in</code> keywords &mdash; preview updates live in the sidebar.</p>
</div></div>
<div class="wizard">
  <!-- Step 1: Run identification and science goal -->
  <div class="wz-step active" role="button" tabindex="0" onclick="wizClick(1)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();wizClick(1);}"><div class="wz-num">1</div><span class="wz-label">Run Info</span></div>
  <!-- Step 2: Particle species and charge state -->
  <div class="wz-step" role="button" tabindex="0" onclick="wizClick(2)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();wizClick(2);}"><div class="wz-num">2</div><span class="wz-label">Particle</span></div>
  <!-- Step 3: Background magnetic field model (TS05/TS04/T96/T01/TS07D/TA15/MHD) -->
  <div class="wz-step" role="button" tabindex="0" onclick="wizClick(3)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();wizClick(3);}"><div class="wz-num">3</div><span class="wz-label">Bkg B-Field</span></div>
  <!-- Step 4: Simulation domain outer boundary (BOX or Shue) -->
  <div class="wz-step" role="button" tabindex="0" onclick="wizClick(4)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();wizClick(4);}"><div class="wz-num">4</div><span class="wz-label">Boundary</span></div>
  <!-- Step 5: Electric field model (NEW ‚Äî corotation + convection) -->
  <div class="wz-step" role="button" tabindex="0" onclick="wizClick(5)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();wizClick(5);}"><div class="wz-num">5</div><span class="wz-label">E-Field</span></div>
  <!-- Step 6: Temporal variability of the geomagnetic field -->
  <div class="wz-step" role="button" tabindex="0" onclick="wizClick(6)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();wizClick(6);}"><div class="wz-num">6</div><span class="wz-label">Temporal</span></div>
  <!-- Step 7: Source particle spectrum at the outer boundary -->
  <div class="wz-step" role="button" tabindex="0" onclick="wizClick(7)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();wizClick(7);}"><div class="wz-num">7</div><span class="wz-label">Spectrum</span></div>
  <!-- Step 8: Output domain ‚Äî trajectory or grid mode -->
  <div class="wz-step" role="button" tabindex="0" onclick="wizClick(8)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();wizClick(8);}"><div class="wz-num">8</div><span class="wz-label">Output Domain</span></div>
  <!-- Step 9: Flux type, energy bins, file format -->
  <div class="wz-step" role="button" tabindex="0" onclick="wizClick(9)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();wizClick(9);}"><div class="wz-num">9</div><span class="wz-label">Output Options</span></div>
  <!-- Step 10: Final review, validation, and CCMC submission -->
  <div class="wz-step" role="button" tabindex="0" onclick="wizClick(10)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();wizClick(10);}"><div class="wz-num">10</div><span class="wz-label">Review &amp; Submit</span></div>
</div>
<div class="layout">
<div class="main-col">

<div id="panel-1" class="step-panel active">
<div class="sect" id="s-runinfo">
  <div class="sect-hd" onclick="toggleSection('s-runinfo')">
    <div class="sect-icon" style="background:rgba(26,136,212,.15)">&#128203;</div>
    <div><div class="sect-title">Run Information</div>
    <div style="font-size:11px;color:var(--text-dim)">Run name, PI contact details, science goal, AMPS version</div></div>
    <span class="sect-sub"><span class="tag tag-new">Step 1</span></span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="sect-body">
    <div class="infobox info-blue"><b>Required fields</b> marked <span style="color:var(--red)">*</span> must be complete before submission. Optional fields help CCMC staff triage and archive your run.</div>
    <div class="frow c2">
      <div class="field"><label>Run Name <span class="req">*</span></label>
        <input id="run-name" type="text" value="SEP_Sep2017_VanAllenProbeA" maxlength="80" oninput="liveUpdate()"/>
        <div class="hint">Alphanumeric + underscores only. Becomes the output directory name and NetCDF global attribute.</div>
        <div id="run-name-err" style="font-size:10px;color:var(--red);"></div>
      </div>
      <div class="field"><label>AMPS Version</label>
        <select id="model-ver" onchange="liveUpdate()">
          <option value="AMPS_2025" selected>AMPS v2025 (current ‚Äî recommended)</option>
          <option value="AMPS_2023">AMPS v2023</option>
          <option value="AMPS_2016">AMPS v2016 (legacy ‚Äî BOX boundary only)</option>
        </select>
        <div class="hint">v2025 adds Shue boundary, coupled-MHD, Band spectrum, and NetCDF4 output.</div>
      </div>
    </div>
    <div class="frow c3">
      <div class="field"><label>PI Name <span class="req">*</span></label>
        <input id="pi-name" type="text" placeholder="Dr. Jane Smith" oninput="liveUpdate()"/>
      </div>
      <div class="field"><label>PI Email <span class="req">*</span></label>
        <input id="pi-email" type="email" placeholder="j.smith@university.edu" oninput="liveUpdate()"/>
        <div class="hint">Run notifications and completion alerts sent here.</div>
      </div>
      <div class="field"><label>Institution</label>
        <input id="pi-inst" type="text" placeholder="Johns Hopkins APL" oninput="liveUpdate()"/>
      </div>
    </div>
    <div class="field" style="margin-bottom:12px;">
      <label>Science Goal</label>
      <select id="science-goal" onchange="goalHint(this.value)">
        <option value="storm_validation" selected>Storm-time validation ‚Äî Van Allen Probes comparison</option>
        <option value="gcr_baseline">GCR baseline ‚Äî quiet-time cosmic ray flux</option>
        <option value="sep_radiation">SEP radiation environment ‚Äî ISS / crew dose</option>
        <option value="parameter_study">Parameter sensitivity study</option>
        <option value="custom">Custom / other</option>
      </select>
      <div class="hint" id="goal-hint" style="color:var(--accent-bright);">Compare AMPS-predicted cutoff rigidity with Van Allen Probe particle data during the storm main phase.</div>
    </div>
    <div class="field">
      <label>Run Description <span class="opt">(optional, 500 chars max)</span></label>
      <textarea id="run-desc" rows="3" maxlength="500" placeholder="Brief scientific description ‚Äî event context, instrument, expected outputs..." oninput="charCount(this,'run-desc-count',500)"></textarea>
      <div class="char-count" id="run-desc-count">0/500</div>
    </div>
  </div>
</div>
</div>


<div id="panel-2" class="step-panel">
<div class="sect" id="s-particle">
  <div class="sect-hd" onclick="toggleSection('s-particle')">
    <div class="sect-icon" style="background:rgba(56,192,255,.12)">&#9883;</div>
    <div><div class="sect-title">Particle Species &amp; Charge State</div>
    <div style="font-size:11px;color:var(--text-dim)">Sets SPECIES, CHARGE, MASS_AMU in AMPS_PARAM.in. One species per run.</div></div>
    <span class="sect-sub"><span class="tag tag-new">Step 2</span></span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="sect-body">
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PARTICLE SPECIES SELECTION PANEL
         
         PURPOSE:
           Allows users to select which particle species to simulate in AMPS.
           One species per simulation run (AMPS uses backward-in-time tracing).
         
         AMPS KEYWORDS AFFECTED:
           SPECIES   = species identifier (e.g., 'proton', 'helium', 'custom')
           CHARGE    = charge state in elementary charges (e.g., +1 for H‚Å∫, +2 for He¬≤‚Å∫)
           MASS_AMU  = atomic mass in unified atomic mass units
         
         CURRENT IMPLEMENTATION:
           Three predefined species cards are shown:
           1. H‚Å∫ Proton  ‚Äî Most common SEP species (Z=+1, A=1.0073 AMU)
           2. He¬≤‚Å∫ Alpha ‚Äî Second most abundant SEP ion (Z=+2, A=4.0026 AMU)
           3. Custom Ion ‚Äî Allows manual input of any charge/mass combination
         
         HOW IT WORKS:
           - User clicks on a species card
           - onclick="selectSpecies(key, this)" is triggered
           - selectSpecies() function (in js/03-bgfield.js):
               1. Updates global state S.species, S.charge, S.mass
               2. Adds 'sel' CSS class to clicked card (visual selection)
               3. Removes 'sel' class from other cards
               4. Shows/hides custom input panel if needed
               5. Recalculates magnetic rigidity display
           - Changes propagate to sidebar summary and AMPS_PARAM.in preview
         
         EXTENSIBILITY:
           To add more predefined species (e.g., electrons, oxygen, iron):
           1. Add a new <div class="opt-card"> below (copy template)
           2. Add corresponding entry to SPECIES object in js/03-bgfield.js
           3. See PARTICLE_SPECIES_EXTENSION_GUIDE.md for detailed instructions
         
         STRUCTURE:
           .opt-grid         ‚Äî Grid container (CSS handles responsive layout)
           .opt-card         ‚Äî Individual species selection card
             .oc-icon        ‚Äî Emoji/icon representing the particle
             .oc-title       ‚Äî Species name with charge state notation
             .oc-sub         ‚Äî Description text (mass, charge, physics notes)
             .oc-badge       ‚Äî Optional badge (e.g., "DEFAULT", "BETA")
           .sel              ‚Äî CSS class marking currently selected card
         
         ACCESSIBILITY:
           - Cards are clickable divs with onclick handlers
           - Keyboard navigation: consider adding tabindex="0" and onkeydown
           - Screen readers: consider adding role="button" and aria-pressed
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    
    <!-- Informational banner explaining AMPS particle tracing behavior -->
    <div class="infobox info-blue">
      <b>AMPS uses backward-in-time tracing</b> ‚Äî one particle species per run. 
      Protons are most common for SEP (Solar Energetic Particle) events. 
      Alpha particles are the second most abundant heavy ion species.
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PARTICLE SPECIES CARDS
         
         LAYOUT SYSTEM:
           .opt-grid.c3 ‚Äî 3-column grid on desktop, responsive on mobile
           CSS in 03-components.css handles:
             - Grid layout and spacing
             - Hover effects
             - Selection state (.sel class)
             - Responsive breakpoints
         
         CARD TEMPLATE:
           <div class="opt-card [sel]" id="sp-{key}" onclick="selectSpecies('{key}',this)">
             <div class="oc-icon">{emoji}</div>
             <div class="oc-title">{Name with superscripts}</div>
             <div class="oc-sub">{Description: mass, charge, physics notes}</div>
             <span class="oc-badge badge-{color}">{BADGE TEXT}</span>
           </div>
         
         ID NAMING CONVENTION:
           sp-{key} where {key} matches the SPECIES object key in JavaScript
           Examples: sp-proton, sp-helium, sp-custom
           This allows JavaScript to find and manipulate specific cards
         
         SELECTION BEHAVIOR:
           - Only ONE card can have class="sel" at a time
           - selectSpecies() removes .sel from all cards, adds to clicked card
           - CSS styles .opt-card.sel with highlighted border/background
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="opt-grid c3">
      
      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
           PROTON CARD (H‚Å∫)
           
           DEFAULT SELECTION:
             - Has class="sel" on page load
             - Most common particle in SEP events
             - AMPS default in legacy versions
           
           PARAMETERS:
             Species key: 'proton'
             Charge (Z):  +1 elementary charge
             Mass (A):    1.0073 atomic mass units (AMU)
           
           PHYSICS NOTES:
             - Full radiation belt treatment available
             - Drift periods: ~10-60 minutes at L=4-6
             - Most SEP events are proton-dominated
             - Cutoff rigidity at LEO: ~1-15 GV depending on location
      ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="opt-card sel" id="sp-proton" onclick="selectSpecies('proton',this)">
        <div class="oc-icon">&#128309;</div> <!-- üîµ Blue circle emoji -->
        <div class="oc-title">H‚Å∫ Proton</div>
        <div class="oc-sub">
          Most common SEP species. Mass = 1.007 AMU, charge = +1e. 
          Full radiation belt treatment.
        </div>
        <span class="oc-badge badge-green">DEFAULT</span>
      </div>
      
      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
           ALPHA PARTICLE CARD (He¬≤‚Å∫)
           
           PARAMETERS:
             Species key: 'helium'
             Charge (Z):  +2 elementary charges
             Mass (A):    4.0026 atomic mass units (AMU)
           
           PHYSICS NOTES:
             - Second most abundant SEP ion (typically 5-10% of proton flux)
             - Fully ionized helium nucleus
             - Higher rigidity than protons at same energy/nucleon
             - Important for heavy ion dose calculations
             - He/H ratio diagnostic for SEP acceleration mechanisms
      ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="opt-card" id="sp-helium" onclick="selectSpecies('helium',this)">
        <div class="oc-icon">&#128993;</div> <!-- üü° Yellow circle emoji -->
        <div class="oc-title">He¬≤‚Å∫ Alpha</div>
        <div class="oc-sub">
          Alpha particles. Second most abundant SEP ion. 
          Mass = 4.003 AMU, charge = +2e.
        </div>
      </div>
      
      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
           CUSTOM ION CARD
           
           PURPOSE:
             Allows simulation of any ion species not in the predefined list.
             Useful for:
               - Exotic heavy ions (CNO, Fe, etc.)
               - Partially stripped ions (e.g., O‚Å∂‚Å∫ instead of O‚Å∏‚Å∫)
               - Hypothetical particles for sensitivity studies
               - Electrons (Z=-1, A=0.000549 AMU)
           
           BEHAVIOR:
             When selected:
               1. Shows #custom-species-panel (hidden by default)
               2. Displays three input fields:
                  - Charge State Z: integer from -1 to +92
                  - Mass: float from 0.0005 to 250 AMU
                  - Ion Label: cosmetic display name (max 8 chars)
               3. User can manually enter any valid combination
           
           DEFAULT CUSTOM VALUES:
             Z = +1, A = 1.0 AMU (generic singly-charged ion)
             User should change these before submitting
      ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="opt-card" id="sp-custom" onclick="selectSpecies('custom',this)">
        <div class="oc-icon">&#9881;</div> <!-- ‚öô Gear emoji -->
        <div class="oc-title">Custom Ion</div>
        <div class="oc-sub">
          Manually specify charge state and mass for exotic or partially-stripped ions.
        </div>
      </div>
      
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         CUSTOM SPECIES INPUT PANEL
         
         VISIBILITY:
           - Hidden by default (style="display:none")
           - Shown when user clicks "Custom Ion" card
           - Hidden when user selects predefined species
           - Controlled by selectSpecies() in js/03-bgfield.js
         
         INPUTS:
           1. Charge State Z [e]
              - Range: -1 (electrons) to +92 (uranium)
              - Step: 1 (integer values only)
              - Used in rigidity calculation: R = p/(q¬∑e)
              - Affects particle trajectory curvature in B-field
           
           2. Mass [AMU]
              - Range: 0.0005 (electron) to 250 (superheavy nuclei)
              - Step: 0.001 (allows precise specification)
              - 1 AMU = 1.66054 √ó 10‚Åª¬≤‚Å∑ kg
              - Affects inertia, drift velocities, energy-to-momentum mapping
           
           3. Ion Label
              - Cosmetic display name only (not used in simulation)
              - Max 8 characters to fit UI layouts
              - Example: "O‚Å∂‚Å∫" for partially stripped oxygen
              - Shown in sidebar and parameter preview
         
         VALIDATION:
           - Min/max attributes enforce physical limits
           - oninput="updateRigidity()" triggers live recalculation
           - Rigidity display updates in real-time as user types
           - No explicit "submit" ‚Äî values update state immediately
         
         DATA FLOW:
           User types ‚Üí oninput fires ‚Üí updateRigidity() reads inputs ‚Üí
           Updates S.charge, S.mass ‚Üí Recalculates rigidity ‚Üí Updates display
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="custom-species-panel" style="display:none;" class="subsection">
      <div class="subsection-title">Custom Ion Parameters</div>
      <div class="frow c3">
        
        <!-- Charge State Input -->
        <div class="field">
          <label>Charge State Z <span class="unit">[e]</span></label>
          <input 
            id="charge-input" 
            type="number" 
            value="1" 
            min="-1" 
            max="92" 
            step="1" 
            oninput="updateRigidity()"
          />
          <div class="hint">
            Net charge in elementary charge units. 
            Examples: +1 for H‚Å∫, +2 for He¬≤‚Å∫, -1 for e‚Åª, +8 for O‚Å∏‚Å∫
          </div>
        </div>
        
        <!-- Mass Input -->
        <div class="field">
          <label>Mass <span class="unit">[AMU]</span></label>
          <input 
            id="mass-input" 
            type="number" 
            value="1.0" 
            min="0.0005" 
            max="250" 
            step="0.001" 
            oninput="updateRigidity()"
          />
          <div class="hint">
            Atomic mass in unified atomic mass units. 
            Examples: 1.007 (H), 4.003 (He), 15.999 (O), 55.845 (Fe)
          </div>
        </div>
        
        <!-- Ion Display Label Input -->
        <div class="field">
          <label>Ion Label</label>
          <input 
            id="ion-symbol" 
            type="text" 
            value="?" 
            maxlength="8" 
            placeholder="e.g. Na‚Å∫"
          />
          <div class="hint">
            Display label only ‚Äî cosmetic. Use Unicode superscripts for charge states.
          </div>
        </div>
        
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         MAGNETIC RIGIDITY DISPLAY
         
         WHAT IS RIGIDITY:
           Magnetic rigidity R = p/(q¬∑e) measures how "stiff" a particle trajectory
           is in a magnetic field. Units: gigavolts (GV).
           
           Higher rigidity = harder to deflect = deeper penetration into magnetosphere
           
           Formula:
             R [GV] = (p [GeV/c]) / (Z [e])
             p = momentum = Œ≥¬∑m¬∑v (relativistic)
             For non-relativistic particles: p ‚âà ‚àö(2¬∑E¬∑m¬∑c¬≤)
         
         WHY IT MATTERS:
           - Earth's magnetic field acts as a "rigidity filter"
           - Each geographic location has a cutoff rigidity R_cutoff
           - Particles with R < R_cutoff cannot reach that location
           - Example: Equatorial cutoff ~15 GV, polar cutoff ~0.1 GV
         
         DISPLAY:
           Shows R at fixed reference energy: 100 MeV/nucleon
           Updates in real-time as user changes Z or A
           Formula implemented in updateRigidity() in js/03-bgfield.js
         
         FORMULA NOTES:
           At 100 MeV/n:
             E_total = A √ó 100 MeV
             For non-relativistic (E << m¬∑c¬≤):
               p ‚âà ‚àö(2¬∑E¬∑m) = ‚àö(2 √ó A √ó 100 MeV √ó A √ó 931.5 MeV)
               R = p / Z
             For relativistic (electrons, high-Z at high energy):
               Use full Œ≥ = (E + m¬∑c¬≤)/(m¬∑c¬≤) expression
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="subsection" style="margin-top:4px;">
      <div style="font-size:11px;color:var(--text-dim);">
        Magnetic rigidity at 100 MeV/n:
        <span 
          id="rigidity-info" 
          style="font-family:var(--font-mono);color:var(--accent-bright);margin-left:6px;"
        >
          R = 1.093 GV
        </span>
        <span style="font-size:10px;color:var(--text-muted);margin-left:8px;">
          (R = p/(q¬∑e) ‚Äî particles with R &lt; R<sub>cutoff</sub> cannot reach LEO)
        </span>
      </div>
    </div>
    
  </div>
</div>
</div>


<div id="panel-3" class="step-panel">
<div class="sect" id="s-bgfield">
  <div class="sect-hd" onclick="toggleSection('s-bgfield')">
    <div class="sect-icon" style="background:rgba(255,208,75,.12)">&#129522;</div>
    <div><div class="sect-title">Background Magnetic Field ‚Äî Model &amp; Driving Parameters</div>
    <div style="font-size:11px;color:var(--text-dim)">Select an empirical Tsyganenko-type model or upload MHD output. Driving parameters shown depend on the model. TS05/TS04 support storm-time reconstruction; T96/T01 provide robust baseline; TS07D uses time-dependent coefficients; TA15 includes GOES total-B.</div></div>
    <span class="sect-sub"><span class="tag tag-new">Step 3</span></span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="sect-body">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         MAGNETIC FIELD MODEL SELECTOR
         Maps to: FIELD_MODEL keyword in AMPS_PARAM.in.

         Empirical models ‚Äî driven by scalar solar-wind / geomag indices:
           TS05   Tsyganenko & Sitnov 2005   ‚Äî storm-time, robust drivers
           TS04   Tsyganenko & Sitnov 2004   ‚Äî storm-time empirical
           T96    Tsyganenko 1996            ‚Äî Dst/Pdyn/By/Bz/tilt baseline
           T01    Tsyganenko 2001            ‚Äî 2001 coefficient family
           TS07D  Tsyganenko & Sitnov 2007D  ‚Äî time-dependent coefficients
           TA15   Tsyganenko & Andreeva 2015 ‚Äî advanced, needs GOES |B|

         MHD simulation output ‚Äî interpolated onto particle grid:
           BATSRUS  CCMC runs (upload .cdf/.h5)
           GAMERA   Lemos et al. 2023 (upload .h5)
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

    <!-- Row 1: TS05 | TS04 -->
    <div class="model-sel-grid" style="grid-template-columns:1fr 1fr;margin-bottom:8px;">

      <!-- TS05: full 8-parameter storm-time model ‚Äî RECOMMENDED DEFAULT -->
      <div class="model-sel-card sel" id="msc-ts05" onclick="selectFieldModel('TS05')">
        <div class="msc-icon">üß≤</div>
        <div class="msc-title">TS05 <span style="font-size:9px;background:rgba(45,212,160,.2);color:var(--green);padding:1px 5px;border-radius:3px;">Recommended</span></div>
        <div class="msc-sub">Tsyganenko &amp; Sitnov (2005). 8 drivers: Dst, Pdyn, Bz, Vx, Nsw, By, Bx, epoch. Best accuracy for storm-time SEP runs. Directly couples to Shue boundary auto-compute and Weimer E-field.</div>
        <div class="msc-badge" style="margin-top:7px;"><code style="font-size:10px;color:var(--green);background:rgba(0,0,0,.3);padding:2px 6px;border-radius:3px;">FIELD_MODEL = TS05</code></div>
      </div>

      <!-- TS04: storm-time empirical model (Tsyganenko & Sitnov 2004) -->
      <div class="model-sel-card" id="msc-ts04" onclick="selectFieldModel('TS04')">
        <div class="msc-icon">‚ö°</div>
        <div class="msc-title">TS04 ‚Äî Storm-time Empirical</div>
        <div class="msc-sub">Tsyganenko &amp; Sitnov (2004). Storm-time model with improved current systems versus T96/T01. Typically used for disturbed intervals; supports parameter studies when TS05 is not required.</div>
        <div class="msc-badge" style="margin-top:7px;"><code style="font-size:10px;color:var(--accent-bright);background:rgba(0,0,0,.3);padding:2px 6px;border-radius:3px;">FIELD_MODEL = TS04</code></div>
      </div>
    </div>

    <!-- Row 2: T96 | T01 -->
    <div class="model-sel-grid" style="grid-template-columns:1fr 1fr;margin-bottom:8px;">

      <!-- T96: solar-wind/IMF driven empirical model -->
      <div class="model-sel-card" id="msc-t96" onclick="selectFieldModel('T96')">
        <div class="msc-icon">üåê</div>
        <div class="msc-title">T96 ‚Äî SW/IMF Driven</div>
        <div class="msc-sub">Tsyganenko (1996). Widely used baseline empirical model driven by Dst, solar-wind dynamic pressure, IMF By/Bz, and dipole tilt. Good for quick event studies when full storm-time W-parameters are not needed.</div>
        <div class="msc-badge" style="margin-top:7px;"><code style="font-size:10px;color:var(--accent-bright);background:rgba(0,0,0,.3);padding:2px 6px;border-radius:3px;">FIELD_MODEL = T96</code></div>
      </div>

      <!-- T01: 2001 model family -->
      <div class="model-sel-card" id="msc-t01" onclick="selectFieldModel('T01')">
        <div class="msc-icon">üß≠</div>
        <div class="msc-title">T01 ‚Äî 2001 Model Family</div>
        <div class="msc-sub">Tsyganenko (2001). Empirical model family commonly exposed as T01QUIET / T01STORM coefficient sets in many toolkits. Uses similar solar-wind/IMF drivers as T96 with improved current-system parameterization.</div>
        <div class="msc-badge" style="margin-top:7px;"><code style="font-size:10px;color:var(--accent-bright);background:rgba(0,0,0,.3);padding:2px 6px;border-radius:3px;">FIELD_MODEL = T01</code></div>
      </div>
    </div>

    <!-- Row 3: TS07D | TA15 -->
    <div class="model-sel-grid" style="grid-template-columns:1fr 1fr;margin-bottom:8px;">

      <!-- TS07D: time-dependent coefficient family -->
      <div class="model-sel-card" id="msc-ts07d" onclick="selectFieldModel('TS07D')">
        <div class="msc-icon">‚è±Ô∏è</div>
        <div class="msc-title">TS07D ‚Äî Time Dependent</div>
        <div class="msc-sub">Tsyganenko &amp; Sitnov (2007D). Time-dependent empirical field model using precomputed coefficient sets (commonly distributed as yearly files). Intended for event reconstructions with evolving storm-time current systems.</div>
        <div class="msc-badge" style="margin-top:7px;"><code style="font-size:10px;color:var(--accent-bright);background:rgba(0,0,0,.3);padding:2px 6px;border-radius:3px;">FIELD_MODEL = TS07D</code></div>
      </div>

      <!-- TA15: Tsyganenko & Andreeva 2015 ‚Äî advanced empirical model -->
      <div class="model-sel-card" id="msc-ta15" onclick="selectFieldModel('TA15')">
        <div class="msc-icon">üî¨</div>
        <div class="msc-title">TA15 ‚Äî Advanced Empirical <span style="font-size:9px;background:rgba(139,111,247,.18);color:var(--purple);padding:1px 5px;border-radius:3px;">Advanced</span></div>
        <div class="msc-sub">Tsyganenko &amp; Andreeva (2015). Uses GOES geostationary total-B plus solar wind/IMF and geomagnetic indices. Highest realism among the empirical suite; requires GOES B input (scalar or uploaded time series).</div>
        <div class="msc-badge" style="margin-top:7px;"><code style="font-size:10px;color:var(--purple);background:rgba(0,0,0,.3);padding:2px 6px;border-radius:3px;">FIELD_MODEL = TA15</code></div>
      </div>
    </div>

    <!-- Row 3: MHD models ‚Äî require file upload -->
    <div style="font-size:10px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;margin:4px 0 7px;border-top:1px solid var(--border);padding-top:10px;">
      MHD Simulation Output ‚Äî upload CCMC run file; AMPS interpolates B onto particle grid
    </div>
    <div class="model-sel-grid" style="grid-template-columns:1fr 1fr;margin-bottom:14px;">

      <!-- BATSRUS: Block-Adaptive Tree Solar-wind Roe Upwind Scheme -->
      <div class="model-sel-card" id="msc-batsrus" onclick="selectFieldModel('BATSRUS')">
        <div class="msc-icon">üåä</div>
        <div class="msc-title">BATSRUS MHD Output</div>
        <div class="msc-sub">Block-Adaptive Tree Solar-wind Roe-Upwind Scheme (Powell et al. 1999). Upload 3-D BATSRUS output file (.cdf or .h5 from a CCMC run). AMPS tri-linearly interpolates B. Most accurate for extreme storm events.</div>
        <div class="msc-badge" style="margin-top:7px;"><code style="font-size:10px;color:var(--orange);background:rgba(0,0,0,.3);padding:2px 6px;border-radius:3px;">FIELD_MODEL = BATSRUS</code></div>
      </div>

      <!-- GAMERA: Grid Agnostic MHD for Extended Research Applications -->
      <div class="model-sel-card" id="msc-gamera" onclick="selectFieldModel('GAMERA')">
        <div class="msc-icon">üéÆ</div>
        <div class="msc-title">GAMERA MHD Output</div>
        <div class="msc-sub">Grid Agnostic MHD for Extended Research Applications (Sorathia et al. 2020). High-resolution curvilinear-mesh global MHD. Upload GAMERA .h5 output. Beta support ‚Äî contact CCMC if issues arise.</div>
        <div class="msc-badge" style="margin-top:7px;"><code style="font-size:10px;color:var(--orange);background:rgba(0,0,0,.3);padding:2px 6px;border-radius:3px;">FIELD_MODEL = GAMERA</code></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         FIELD-MODEL-SPECIFIC INPUT FORMS
         Only one form is shown at a time; selectFieldModel() toggles visibility.
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

    <!-- ‚îÄ‚îÄ TS05 / TS04 form (shared inputs ‚Äî storm-time driver UI) ‚îÄ‚îÄ -->
    <div id="ts05-form">
      <div id="ts05-label" style="font-size:11px;font-weight:700;color:var(--accent-bright);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px;">TS05 Driving Parameters</div>
    <div class="infobox info-orange">
      <b>Example presets:</b> <span style="color:var(--text-dim)">quiet</span> (Dst‚âà‚àí10 nT, Pdyn‚âà2 nPa, Bz‚âà+2 nT, Vx‚âà‚àí400 km/s, Nsw‚âà5 cm&#8315;&#179;) and <span style="color:var(--text-dim)">storm</span> (Dst‚âà‚àí150 nT, Pdyn‚âà8 nPa, Bz‚âà‚àí20 nT, Vx‚âà‚àí700 km/s, Nsw‚âà15 cm&#8315;&#179;). Use OMNI/CCMC iSWA values for event runs.
    </div>
    <div class="frow c4">
      <div class="field"><label>Dst <span class="unit">[nT]</span> <span class="req">*</span></label>
        <input id="ts05-dst" type="number" value="-142.0" step="1" min="-600" max="50" class="error" oninput="ts05Change()"/>
        <div id="ts05-dst-status" class="field-note" style="color:var(--red);">&#10007; Storm-time ‚Äî verify data source</div>
        <div class="hint">Storm main phase: &#8722;100 to &#8722;300 nT. TS05 limit: &#8722;600 nT.</div>
      </div>
      <div class="field"><label>Pdyn <span class="unit">[nPa]</span> <span class="req">*</span></label>
        <input id="ts05-pdyn" type="number" value="3.5" step="0.1" min="0.1" max="30" class="valid" oninput="ts05Change()"/>
        <div id="ts05-pdyn-status" class="field-note" style="color:var(--green);">&#10003; Within normal range</div>
        <div class="hint">Dynamic pressure. Sets magnetopause standoff distance.</div>
      </div>
      <div class="field"><label>IMF Bz <span class="unit">[nT GSM]</span> <span class="req">*</span></label>
        <input id="ts05-bz" type="number" value="-18.5" step="0.1" min="-50" max="20" class="warn" oninput="ts05Change()"/>
        <div id="ts05-bz-status" class="field-note" style="color:var(--orange);">&#9888; Strong southward ‚Äî storm driver</div>
        <div class="hint">Negative = southward = reconnection onset.</div>
      </div>
      <div class="field"><label>Epoch <span class="unit">[UTC]</span></label>
        <input id="ts05-epoch" type="datetime-local" value="2017-09-10T16:00" oninput="liveUpdate()"/>
        <div class="hint">Snapshot timestamp for STEADY_STATE mode.</div>
      </div>
    </div>
    <div class="frow c4">
      <div class="field"><label>Vx <span class="unit">[km/s]</span></label>
        <input id="ts05-vx" type="number" value="-650.0" step="10" min="-900" max="-200" class="valid" oninput="ts05Change()"/>
        <div id="ts05-vx-status" class="field-note" style="color:var(--green);">&#10003; OK</div>
        <div class="hint">Solar wind velocity (negative = sunward). Typical &#8722;400 km/s.</div>
      </div>
      <div class="field"><label>Nsw <span class="unit">[cm&#8315;&#179;]</span></label>
        <input id="ts05-nsw" type="number" value="12.0" step="0.5" min="0.5" max="80" class="valid" oninput="ts05Change()"/>
        <div id="ts05-nsw-status" class="field-note" style="color:var(--green);">&#10003; OK</div>
        <div class="hint">Proton number density.</div>
      </div>
      <div class="field"><label>IMF By <span class="unit">[nT]</span> <span class="opt">opt</span></label>
        <input id="ts05-by" type="number" value="3.2" step="0.1" min="-40" max="40" class="valid" oninput="ts05Change()"/>
        <div class="hint">Dawn-dusk asymmetry. Set 0 if unknown.</div>
      </div>
      <div class="field"><label>IMF Bx <span class="unit">[nT]</span> <span class="opt">opt</span></label>
        <input id="ts05-bx" type="number" value="0.0" step="0.1" min="-40" max="40" class="valid" oninput="ts05Change()"/>
        <div class="hint">Usually 0.</div>
      </div>
    </div>
    </div><!-- /ts05-form -->

    <!-- ‚îÄ‚îÄ T96 form: Dst + Pdyn + IMF By/Bz + dipole tilt ‚îÄ‚îÄ -->
    <div id="t96-form" style="display:none;">
      <div style="font-size:11px;font-weight:700;color:var(--accent-bright);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px;">T96 Driving Parameters</div>
      <div class="infobox info-blue" style="margin-bottom:10px;">
        Typical examples (order-of-magnitude): <b>quiet</b> Dst‚âà0 to ‚àí20 nT, Pdyn‚âà1‚Äì3 nPa, IMF Bz‚âà0 to +5 nT;
        <b>storm</b> Dst&lt;‚àí100 nT, Pdyn‚âà5‚Äì15 nPa, IMF Bz‚âà‚àí10 to ‚àí25 nT. (Refs: NOAA SWPC Dst/storm levels; NASA OMNIWeb typical solar-wind values.)
      </div>
      <div class="frow c4">
        <div class="field"><label>Dst <span class="unit">[nT]</span> <span class="req">*</span></label>
          <input id="t96-dst" type="number" value="-20" step="1" min="-600" max="50" oninput="t96Change()"/>
        </div>
        <div class="field"><label>Pdyn <span class="unit">[nPa]</span> <span class="req">*</span></label>
          <input id="t96-pdyn" type="number" value="2.0" step="0.1" min="0.1" max="30" oninput="t96Change()"/>
        </div>
        <div class="field"><label>IMF By <span class="unit">[nT]</span></label>
          <input id="t96-by" type="number" value="0.0" step="0.1" min="-40" max="40" oninput="t96Change()"/>
        </div>
        <div class="field"><label>IMF Bz <span class="unit">[nT]</span> <span class="req">*</span></label>
          <input id="t96-bz" type="number" value="2.0" step="0.1" min="-50" max="20" oninput="t96Change()"/>
        </div>
      </div>
      <div class="frow c4">
        <div class="field"><label>Dipole tilt <span class="unit">[deg]</span></label>
          <input id="t96-tilt" type="number" value="0.0" step="0.5" min="-35" max="35" oninput="t96Change()"/>
          <div class="hint">If unknown, leave 0; future option: compute from epoch/IGRF.</div>
        </div>
      </div>
    </div><!-- /t96-form -->

    <!-- ‚îÄ‚îÄ T01 form: similar driver set (quiet/storm coefficient sets) ‚îÄ‚îÄ -->
    <div id="t01-form" style="display:none;">
      <div style="font-size:11px;font-weight:700;color:var(--accent-bright);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px;">T01 Driving Parameters</div>
      <div class="infobox info-blue" style="margin-bottom:10px;">
        T01 commonly uses the same core solar-wind/IMF driver set as T96 (Dst, Pdyn, By/Bz, tilt) with updated current-system parameterization.
        Select the appropriate coefficient set (quiet/storm) in the backend; UI uses the same inputs.
      </div>
      <div class="frow c4">
        <div class="field"><label>Dst <span class="unit">[nT]</span> <span class="req">*</span></label>
          <input id="t01-dst" type="number" value="-20" step="1" min="-600" max="50" oninput="t01Change()"/>
        </div>
        <div class="field"><label>Pdyn <span class="unit">[nPa]</span> <span class="req">*</span></label>
          <input id="t01-pdyn" type="number" value="2.0" step="0.1" min="0.1" max="30" oninput="t01Change()"/>
        </div>
        <div class="field"><label>IMF By <span class="unit">[nT]</span></label>
          <input id="t01-by" type="number" value="0.0" step="0.1" min="-40" max="40" oninput="t01Change()"/>
        </div>
        <div class="field"><label>IMF Bz <span class="unit">[nT]</span> <span class="req">*</span></label>
          <input id="t01-bz" type="number" value="2.0" step="0.1" min="-50" max="20" oninput="t01Change()"/>
        </div>
      </div>
      <div class="frow c4">
        <div class="field"><label>Dipole tilt <span class="unit">[deg]</span></label>
          <input id="t01-tilt" type="number" value="0.0" step="0.5" min="-35" max="35" oninput="t01Change()"/>
        </div>
      </div>
    </div><!-- /t01-form -->

    <!-- ‚îÄ‚îÄ TS07D form: coefficient source (file vs OMNI) ‚îÄ‚îÄ -->
    <div id="ts07d-form" style="display:none;">
      <div style="font-size:11px;font-weight:700;color:var(--accent-bright);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px;">TS07D Coefficient Inputs</div>
      <div class="infobox info-orange" style="margin-bottom:10px;">
        TS07D is time-dependent and typically distributed as yearly coefficient files. Select a coefficient source below.
      </div>
      <div class="frow c4">
        <div class="field"><label>Coefficient source</label>
          <select id="ts07d-source" oninput="ts07dChange()">
            <option value="omni" selected>OMNI-derived (CCMC backend)</option>
            <option value="file">Upload TS07D coefficient file</option>
          </select>
        </div>
        <div class="field"><label>Epoch <span class="unit">[UTC]</span></label>
          <input id="ts07d-epoch" type="datetime-local" value="2017-09-10T16:00" oninput="ts07dChange()"/>
        </div>
      </div>
      <div class="dropzone" id="ts07d-dropzone" onclick="this.classList.toggle('loaded')" style="margin-top:10px;display:none;">
        <div class="dz-icon">üìÇ</div>
        <div class="dz-primary">Drop TS07D coefficient file here or click to browse</div>
        <div class="dz-sub">.dat ¬∑ .txt ¬∑ max 200 MB</div>
      </div>
    </div><!-- /ts07d-form -->

    <!-- ‚îÄ‚îÄ TA15 form: GOES B + solar wind + Dst ‚îÄ‚îÄ -->
    <div id="ta15-form" style="display:none;">
      <div style="font-size:11px;font-weight:700;color:var(--purple);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px;">TA15 Driving Parameters</div>
      <div class="infobox info-blue" style="margin-bottom:10px;">
        TA15 requires <b>GOES geostationary total B</b> in addition to the standard solar-wind/IMF inputs.
        Typical geostationary |B| is ~100‚Äì200 nT (varies with local time and activity).
      </div>
      <div class="frow c4">
        <div class="field"><label>Dst <span class="unit">[nT]</span> <span class="req">*</span></label>
          <input id="ta15-dst" type="number" value="-20" step="1" min="-600" max="50" oninput="ta15Change()"/>
        </div>
        <div class="field"><label>Pdyn <span class="unit">[nPa]</span> <span class="req">*</span></label>
          <input id="ta15-pdyn" type="number" value="2.0" step="0.1" min="0.1" max="30" oninput="ta15Change()"/>
        </div>
        <div class="field"><label>IMF Bz <span class="unit">[nT]</span> <span class="req">*</span></label>
          <input id="ta15-bz" type="number" value="2.0" step="0.1" min="-50" max="20" oninput="ta15Change()"/>
        </div>
        <div class="field"><label>GOES |B| <span class="unit">[nT]</span> <span class="req">*</span></label>
          <input id="ta15-goes" type="number" value="120" step="1" min="50" max="300" oninput="ta15Change()"/>
        </div>
      </div>
    </div><!-- /ta15-form -->

    <!-- ‚îÄ‚îÄ MHD file upload form (BATSRUS or GAMERA) ‚îÄ‚îÄ -->
    <!-- AMPS reads the 3-D magnetic field directly from a global MHD
         simulation output file and tri-linearly interpolates B onto
         the particle trajectory. This avoids any empirical parameterization
         but requires a complete BATSRUS or GAMERA run to be available. -->
    <div id="mhd-form" style="display:none;">
      <div id="mhd-model-label" style="font-size:11px;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px;">BATSRUS MHD Output</div>
      <div class="infobox info-orange" style="margin-bottom:10px;">
        <b>MHD file required:</b> Run BATSRUS or GAMERA via the
        <a href="https://ccmc.gsfc.nasa.gov/requests/requests_main.php" target="_blank"
        style="color:var(--accent-bright);">CCMC Runs-on-Request</a> portal first,
        then upload the 3-D output file below. AMPS will tri-linearly interpolate
        B(x,y,z) onto each particle position at runtime.
      </div>
      <div class="dropzone" id="mhd-dropzone" onclick="this.classList.toggle('loaded')" style="margin-bottom:12px;">
        <div class="dz-icon">üìÇ</div>
        <div class="dz-primary">Drop BATSRUS/GAMERA output file here or click to browse</div>
        <div class="dz-sub">.cdf ¬∑ .h5 ¬∑ .hdf5 ¬∑ max 2 GB</div>
      </div>
      <div class="frow c4">
        <div class="field">
          <label>Interpolation method</label>
          <select id="mhd-interp" oninput="mhdChange()">
            <option value="LINEAR" selected>Tri-linear (fast, default)</option>
            <option value="CUBIC">Tri-cubic (smoother, 3√ó slower)</option>
          </select>
          <div class="hint">Tri-linear is recommended for most runs. Use tri-cubic only if
            the MHD grid is coarser than ~0.5 RE near LEO.</div>
        </div>
        <div class="field">
          <label>Coordinate system</label>
          <select id="mhd-coords">
            <option value="GSM" selected>GSM (default)</option>
            <option value="GSE">GSE (auto-rotate to GSM)</option>
          </select>
        </div>
      </div>
    </div><!-- /mhd-form -->

    <!-- ‚îÄ‚îÄ AMPS_PARAM.in keyword preview (all models) ‚îÄ‚îÄ -->
    <div class="kw-strip" id="ts05-kw-preview">
<span class="kw-section">#BACKGROUND_FIELD</span>
<span class="kw-key">FIELD_MODEL</span>     <span class="kw-val" id="kv-field-model">TS05</span>      <span class="kw-comment">! Tsyganenko &amp; Sitnov (2005)</span>
<!-- TS05/TS04 rows ‚Äî hidden when other model selected -->
<span class="ts05-kw-row"><span class="kw-key">DST</span>             <span class="kw-val" id="kv-dst">-142.0</span>    <span class="kw-comment">! nT ring current index</span>
</span><span class="ts05-kw-row"><span class="kw-key">PDYN</span>            <span class="kw-val" id="kv-pdyn">3.50</span>      <span class="kw-comment">! nPa dynamic pressure</span>
</span><span class="ts05-kw-row"><span class="kw-key">IMF_BZ</span>          <span class="kw-val" id="kv-bz">-18.50</span>    <span class="kw-comment">! nT GSM southward component</span>
</span><span class="ts05-kw-row"><span class="kw-key">SW_VX</span>           <span class="kw-val" id="kv-vx">-650.0</span>    <span class="kw-comment">! km/s solar wind velocity</span>
</span><span class="ts05-kw-row"><span class="kw-key">SW_NSW</span>          <span class="kw-val" id="kv-nsw">12.00</span>     <span class="kw-comment">! cm‚Åª¬≥ proton density</span>
</span><span class="ts05-kw-row"><span class="kw-key">IMF_BY</span>          <span class="kw-val" id="kv-by">3.20</span>      <span class="kw-comment">! nT dawn-dusk component</span>
</span><span class="ts05-kw-row"><span class="kw-key">IMF_BX</span>          <span class="kw-val" id="kv-bx">0.00</span>      <span class="kw-comment">! nT (optional)</span>
</span><!-- T96/T01 rows ‚Äî hidden unless T96 or T01 selected -->
<span class="t96-kw-row" style="display:none;"><span class="kw-key">DST</span>             <span class="kw-val" id="kv-t96-dst">-20.0</span>    <span class="kw-comment">! nT</span>
</span><span class="t96-kw-row" style="display:none;"><span class="kw-key">PDYN</span>            <span class="kw-val" id="kv-t96-pdyn">2.00</span>     <span class="kw-comment">! nPa</span>
</span><span class="t96-kw-row" style="display:none;"><span class="kw-key">IMF_BY</span>          <span class="kw-val" id="kv-t96-by">0.00</span>     <span class="kw-comment">! nT</span>
</span><span class="t96-kw-row" style="display:none;"><span class="kw-key">IMF_BZ</span>          <span class="kw-val" id="kv-t96-bz">2.00</span>     <span class="kw-comment">! nT</span>
</span><span class="t96-kw-row" style="display:none;"><span class="kw-key">TILT</span>            <span class="kw-val" id="kv-t96-tilt">0.0</span>      <span class="kw-comment">! deg</span>
</span>
<span class="t01-kw-row" style="display:none;"><span class="kw-key">DST</span>             <span class="kw-val" id="kv-t01-dst">-20.0</span>    <span class="kw-comment">! nT</span>
</span><span class="t01-kw-row" style="display:none;"><span class="kw-key">PDYN</span>            <span class="kw-val" id="kv-t01-pdyn">2.00</span>     <span class="kw-comment">! nPa</span>
</span><span class="t01-kw-row" style="display:none;"><span class="kw-key">IMF_BY</span>          <span class="kw-val" id="kv-t01-by">0.00</span>     <span class="kw-comment">! nT</span>
</span><span class="t01-kw-row" style="display:none;"><span class="kw-key">IMF_BZ</span>          <span class="kw-val" id="kv-t01-bz">2.00</span>     <span class="kw-comment">! nT</span>
</span><span class="t01-kw-row" style="display:none;"><span class="kw-key">TILT</span>            <span class="kw-val" id="kv-t01-tilt">0.0</span>      <span class="kw-comment">! deg</span>
</span>
<!-- TS07D rows ‚Äî hidden unless TS07D selected -->
<span class="ts07d-kw-row" style="display:none;"><span class="kw-key">COEFF_SOURCE</span>   <span class="kw-val" id="kv-ts07d-source">omni</span>
</span><span class="ts07d-kw-row" style="display:none;"><span class="kw-key">EPOCH</span>           <span class="kw-val" id="kv-ts07d-epoch">2017-09-10T16:00</span>
</span>
<!-- TA15 rows ‚Äî hidden unless TA15 selected -->
<span class="ta15-kw-row" style="display:none;"><span class="kw-key">DST</span>             <span class="kw-val" id="kv-ta15-dst">-20.0</span>    <span class="kw-comment">! nT</span>
</span><span class="ta15-kw-row" style="display:none;"><span class="kw-key">PDYN</span>            <span class="kw-val" id="kv-ta15-pdyn">2.0</span>      <span class="kw-comment">! nPa</span>
</span><span class="ta15-kw-row" style="display:none;"><span class="kw-key">IMF_BZ</span>          <span class="kw-val" id="kv-ta15-bz">2.0</span>      <span class="kw-comment">! nT</span>
</span><span class="ta15-kw-row" style="display:none;"><span class="kw-key">GOES_B</span>          <span class="kw-val" id="kv-ta15-goes">120.0</span>    <span class="kw-comment">! nT</span>
</span>
<!-- MHD rows ‚Äî hidden unless BATSRUS/GAMERA selected -->
<span class="mhd-kw-row" style="display:none;"><span class="kw-key">MHD_FILE</span>        <span class="kw-val" id="kv-mhd-file">(upload required)</span>
</span><span class="mhd-kw-row" style="display:none;"><span class="kw-key">MHD_INTERP</span>      <span class="kw-val" id="kv-mhd-interp">LINEAR</span>   <span class="kw-comment">! LINEAR | CUBIC</span>
</span><span class="kw-key">EPOCH</span>           <span class="kw-val" id="kv-epoch">2017-09-10T16:00</span></div>
  </div>
</div>
</div>


<div id="panel-4" class="step-panel">
<div class="sect" id="s-boundary">
  <div class="sect-hd" onclick="toggleSection('s-boundary')">
    <div class="sect-icon" style="background:rgba(139,111,247,.15)">&#128754;</div>
    <div><div class="sect-title">Simulation Domain Boundary</div>
    <div style="font-size:11px;color:var(--text-dim)">Outer boundary where particles are injected and escape. Maps to #DOMAIN_BOUNDARY in AMPS_PARAM.in.</div></div>
    <span class="sect-sub"><span class="tag tag-new">NEW &middot; Step 4</span></span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="sect-body">
    <div class="infobox info-blue"><b>Physical role:</b> AMPS traces test particles backward in time. Particles reaching this outer boundary are assigned the source spectrum (Panel 6). A physics-based Shue boundary eliminates ~20&#8211;30% of wasted traces vs. a fixed box during storms.</div>
    <div class="bnd-cards">
      <div class="bnd-card" id="bc-box" onclick="bndSet('BOX')">
        <div class="bc-icon">&#128230;</div>
        <div class="bc-title">Rectangular Box (GSM)</div>
        <div class="bc-desc">Axis-aligned cuboid in GSM coordinates. Simple, predictable geometry. Reproduces AMPS 2016 legacy behavior. Best for GCR runs and systematic sweeps.</div>
        <div class="bc-formula">BOUNDARY_TYPE = BOX</div>
      </div>
      <div class="bnd-card sel" id="bc-shue" onclick="bndSet('SHUE')">
        <div class="bc-icon">&#127760;</div>
        <div class="bc-title">Shue Magnetopause (1998) &#9733; Recommended</div>
        <div class="bc-desc">Physics-based magnetopause surface. r&#8320; and &#945; respond to TS05 Pdyn and Bz. Automatically compresses during storms. Fewer wasted particle traces.</div>
        <div class="bc-formula">BOUNDARY_TYPE = SHUE<br>r(&#952;) = r&#8320; &middot; (2&#8725;(1+cos&#952;))^&#945;</div>
      </div>
    </div>

    <!-- BOX PANEL -->
    <div id="bnd-box-panel" style="display:none;">
      <div style="display:grid;grid-template-columns:1fr 420px;gap:16px;align-items:start;">
        <div>
          <div class="hlabel">
            <h4>Box Faces &#8212; GSM [R<sub>E</sub>]</h4>
            <span style="font-size:10px;color:var(--text-dim);">1 R<sub>E</sub> = 6,371 km</span>
          </div>
          <div class="infobox info-blue" style="margin-bottom:10px;font-size:11px;">
            <b>Convention:</b> X<sub>GSM</sub> sunward (+), Z<sub>GSM</sub> northward (+), Y<sub>GSM</sub> dawnward = Z√óX.
            Particles leaving this box are recorded as "escaped to solar wind."
          </div>

          <div class="dim-grid box6">
            <div class="dim-pair">
              <label>X<sub>max</sub> <span class="unit">[R<sub>E</sub>, dayside]</span></label>
              <input id="box-xmax" type="number" value="15" step="0.5" oninput="bndBoxUpdate()"
                title="Dayside (sunward) face. Must exceed magnetopause standoff (~10‚Äì12 RE quiet)."/>
              <div class="hint-val">Typical: 12‚Äì20 R<sub>E</sub></div>
            </div>
            <div class="dim-pair">
              <label>X<sub>min</sub> <span class="unit">[R<sub>E</sub>, nightside]</span></label>
              <input id="box-xmin" type="number" value="-60" step="1" oninput="bndBoxUpdate()"
                title="Nightside tail. Typical ‚àí40 to ‚àí100 RE."/>
              <div class="hint-val">Typical: ‚àí40 to ‚àí100 R<sub>E</sub></div>
            </div>
            <div class="dim-pair">
              <label>Y<sub>max</sub> <span class="unit">[R<sub>E</sub>, dusk]</span></label>
              <input id="box-ymax" type="number" value="25" step="0.5" oninput="bndBoxUpdate()"
                title="Dusk flank. Typically ¬±20‚Äì30 RE."/>
              <div class="hint-val">Typical: 20‚Äì30 R<sub>E</sub></div>
            </div>
            <div class="dim-pair">
              <label>Y<sub>min</sub> <span class="unit">[R<sub>E</sub>, dawn]</span></label>
              <input id="box-ymin" type="number" value="-25" step="0.5" oninput="bndBoxUpdate()"
                title="Dawn flank. Symmetric by default."/>
              <div class="hint-val">Typical: ‚àí20 to ‚àí30 R<sub>E</sub></div>
            </div>
            <div class="dim-pair">
              <label>Z<sub>max</sub> <span class="unit">[R<sub>E</sub>, north]</span></label>
              <input id="box-zmax" type="number" value="20" step="0.5" oninput="bndBoxUpdate()"
                title="North polar boundary. At X~0, magnetopause ~15‚Äì18 RE."/>
              <div class="hint-val">Typical: 15‚Äì25 R<sub>E</sub></div>
            </div>
            <div class="dim-pair">
              <label>Z<sub>min</sub> <span class="unit">[R<sub>E</sub>, south]</span></label>
              <input id="box-zmin" type="number" value="-20" step="0.5" oninput="bndBoxUpdate()"
                title="South polar boundary. Typically symmetric with Z_max."/>
              <div class="hint-val">Typical: ‚àí15 to ‚àí25 R<sub>E</sub></div>
            </div>
          </div>

          <div style="margin-top:4px;margin-bottom:10px;">
            <div class="dim-pair" style="max-width:200px;">
              <label>R<sub>inner</sub> <span class="unit">[R<sub>E</sub>]</span></label>
              <input id="box-rinner" type="number" value="2.0" step="0.1" min="1.0" max="4.0" oninput="bndBoxUpdate()"
                title="Inner loss boundary. Particles reaching this sphere precipitate."/>
              <div class="hint-val">Loss cone sphere. Default 2 R<sub>E</sub>. Maps to <code style="font-family:var(--font-mono);font-size:9px;">R_INNER</code>.</div>
            </div>
          </div>
          <div class="val-row">
            <div class="v-item" id="bv-xrange"><span class="v-ok">&#10003; Dayside OK</span></div>
            <div class="v-item" id="bv-yrange"><span class="v-ok">&#10003; Flanks OK</span></div>
            <div class="v-item" id="bv-zrange"><span class="v-ok">&#10003; Z OK</span></div>
            <div class="v-item" id="bv-inner"><span class="v-ok">&#10003; R_inner OK</span></div>
          </div>
          <div class="kw-strip" style="margin-top:10px;">
<span class="kw-section">#DOMAIN_BOUNDARY</span>
<span class="kw-key">BOUNDARY_TYPE</span>  <span class="kw-val">BOX</span>
<span class="kw-key">DOMAIN_X_MAX</span>   <span class="kw-val" id="kw-xmax">15.0</span>
<span class="kw-key">DOMAIN_X_MIN</span>   <span class="kw-val" id="kw-xmin">-60.0</span>
<span class="kw-key">DOMAIN_Y_MAX</span>   <span class="kw-val" id="kw-ymax">25.0</span>
<span class="kw-key">DOMAIN_Y_MIN</span>   <span class="kw-val" id="kw-ymin">-25.0</span>
<span class="kw-key">DOMAIN_Z_MAX</span>   <span class="kw-val" id="kw-zmax">20.0</span>
<span class="kw-key">DOMAIN_Z_MIN</span>   <span class="kw-val" id="kw-zmin">-20.0</span>
<span class="kw-key">R_INNER</span>        <span class="kw-val" id="kw-rinner">2.0</span></div>
        </div>
        <div class="bnd-diagram">
          <div class="bnd-diag-title">GSM X&#8211;Z plane (Y=0) <span class="bnd-diag-sub">live update</span></div>
          <div class="bnd-svg-wrap">
            <svg id="box-svg" viewBox="0 0 400 320" style="width:100%;height:290px;background:#060e1c;border-radius:4px;display:block;">
              <defs><marker id="ah" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#38c0ff"/></marker></defs>
              <g id="box-grid"></g>
              <line x1="10" y1="160" x2="390" y2="160" stroke="#1a3358" stroke-width="1"/>
              <line x1="200" y1="10" x2="200" y2="310" stroke="#1a3358" stroke-width="1"/>
              <text x="368" y="155" fill="#6a88b0" font-size="10" font-family="IBM Plex Mono">+X &#9728;</text>
              <text x="182" y="22" fill="#6a88b0" font-size="10" font-family="IBM Plex Mono">+Z N</text>
              <circle cx="200" cy="160" r="6" fill="#1a88d4"/>
              <circle id="inner-box" cx="200" cy="160" r="10" fill="rgba(255,90,90,.07)" stroke="#ff5a5a" stroke-width="1.2" stroke-dasharray="3,3"/>
              <rect id="box-rect" x="40" y="60" width="284" height="200" fill="rgba(56,192,255,.04)" stroke="#38c0ff" stroke-width="1.5" stroke-dasharray="7,4"/>
              <text id="box-lbl-xmax" x="305" y="173" fill="#38c0ff" font-size="9" font-family="IBM Plex Mono">Xmax=15</text>
              <text id="box-lbl-xmin" x="14" y="173" fill="#38c0ff" font-size="9" font-family="IBM Plex Mono">-60</text>
              <text id="box-lbl-zmax" x="204" y="54" fill="#38c0ff" font-size="9" font-family="IBM Plex Mono">Zmax=20</text>
              <text id="box-lbl-zmin" x="204" y="274" fill="#38c0ff" font-size="9" font-family="IBM Plex Mono">Zmin=-20</text>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- SHUE PANEL -->
    <div id="bnd-shue-panel">
      <div style="display:grid;grid-template-columns:1fr 420px;gap:16px;align-items:start;">
        <div>
          <div class="shue-auto" id="shue-auto-box">
            <div class="shue-auto-title">üîÅ Auto-computed from TS05 driving parameters (Panel 3)</div>
            <div class="shue-params">
              <div class="shue-param">
                <div class="shue-param-label">r‚ÇÄ <span style="font-size:9px;">[R<sub>E</sub>]</span></div>
                <div class="shue-param-val" id="shue-r0-val">8.56</div>
                <div class="shue-param-eq">= (11.4+0.013Bz)¬∑Pdyn^(‚àí1/6.6)</div>
              </div>
              <div class="shue-param">
                <div class="shue-param-label">Œ±</div>
                <div class="shue-param-val" id="shue-alpha-val">0.617</div>
                <div class="shue-param-eq">= (0.58‚àí0.007Bz)¬∑(1+0.024 ln Pdyn)</div>
              </div>
              <div class="shue-param">
                <div class="shue-param-label">X<sub>sub</sub> [R<sub>E</sub>]</div>
                <div class="shue-param-val" id="shue-xsub-val">8.56</div>
                <div class="shue-param-eq">= r‚ÇÄ (Œ∏=0¬∞)</div>
              </div>
              <div class="shue-param">
                <div class="shue-param-label">R<sub>flank</sub> [R<sub>E</sub>]</div>
                <div class="shue-param-val" id="shue-rflank-val">13.4</div>
                <div class="shue-param-eq">= r(Œ∏=90¬∞)</div>
              </div>
            </div>
          </div>
          <div class="tog" id="shue-mode-tog" style="margin-bottom:10px;">
            <button class="tog-btn on" id="shue-auto-btn" onclick="shueMode('auto')">üîÑ Auto from TS05</button>
            <button class="tog-btn" id="shue-manual-btn" onclick="shueMode('manual')">‚úèÔ∏è Manual override</button>
          </div>
          <div id="shue-manual-fields" style="display:none;">
            <div class="infobox info-orange" style="font-size:11px;margin-bottom:10px;">
              Manual override disables auto-coupling to TS05. Use the Shue (1998) formulas as a guide:
              r‚ÇÄ = (11.4 + 0.013¬∑Bz)¬∑Pdyn^(‚àí1/6.6), Œ± = (0.58 ‚àí 0.007¬∑Bz)¬∑(1 + 0.024¬∑ln Pdyn).
            </div>
            <div class="dim-grid shue2" style="margin-bottom:10px;">
              <div class="dim-pair">
                <label>r‚ÇÄ ‚Äî Subsolar standoff <span class="unit">[R<sub>E</sub>]</span></label>
                <input id="shue-r0-in" type="number" value="8.56" step="0.1" min="4" max="14" oninput="bndShueUpdate()"/>
                <div class="hint-val">Quiet: ~11.2 ¬∑ Storm: ~8.6 ¬∑ Extreme: ~6.5 R<sub>E</sub></div>
              </div>
              <div class="dim-pair">
                <label>Œ± ‚Äî Flaring parameter</label>
                <input id="shue-alpha-in" type="number" value="0.617" step="0.01" min="0.3" max="0.9" oninput="bndShueUpdate()"/>
                <div class="hint-val">Typical 0.50‚Äì0.65. Southward Bz ‚Üí larger Œ±.</div>
              </div>
            </div>
          </div>
          <div class="dim-grid shue2" style="margin-bottom:10px;">
            <div class="dim-pair">
              <label>R<sub>inner</sub> <span class="unit">[R<sub>E</sub>]</span></label>
              <input id="shue-rinner" type="number" value="2.0" step="0.1" min="1" max="4" oninput="bndShueUpdate()"/>
              <div class="hint-val">Inner loss sphere. Default 2 R<sub>E</sub>. Maps to R_INNER.</div>
            </div>
            <div class="dim-pair">
              <label>X<sub>tail</sub> <span class="unit">[R<sub>E</sub>, nightside cap]</span></label>
              <input id="shue-xtail" type="number" value="-60" step="5" max="-20" oninput="bndShueUpdate()"/>
              <div class="hint-val">Closes the open Shue surface tailward. Typical ‚àí40 to ‚àí100 R<sub>E</sub>.</div>
            </div>
          </div>
          <div class="val-row" style="margin-bottom:10px;">
            <div class="v-item" id="sv-r0"><span class="v-ok">&#10003; r&#8320;=8.56 OK</span></div>
            <div class="v-item" id="sv-alpha"><span class="v-ok">&#10003; &#945;=0.617 OK</span></div>
            <div class="v-item" id="sv-tail"><span class="v-ok">&#10003; Tail cap OK</span></div>
          </div>
          <div class="kw-strip">
<span class="kw-section">#DOMAIN_BOUNDARY</span>
<span class="kw-key">BOUNDARY_TYPE</span>  <span class="kw-val">SHUE</span>         <span class="kw-comment">! Shue et al. 1998</span>
<span class="kw-key">SHUE_R0</span>        <span class="kw-auto" id="kw-shue-r0">AUTO</span>         <span class="kw-comment">! RE; AUTO = from TS05 Bz,Pdyn</span>
<span class="kw-key">SHUE_ALPHA</span>     <span class="kw-auto" id="kw-shue-alpha">AUTO</span>         <span class="kw-comment">! AUTO = from TS05</span>
<span class="kw-key">DOMAIN_X_TAIL</span>  <span class="kw-val" id="kw-xtail">-60.0</span>       <span class="kw-comment">! RE flat nightside cap</span>
<span class="kw-key">R_INNER</span>        <span class="kw-val" id="kw-shue-rinner">2.0</span>         <span class="kw-comment">! RE inner loss sphere</span></div>
        </div>
        <div class="bnd-diagram">
          <div class="bnd-diag-title">Shue Magnetopause &#8212; GSM X&#8211;Z plane <span class="bnd-diag-sub">live</span></div>
          <div class="bnd-svg-wrap">
            <svg id="shue-svg" viewBox="0 0 400 320" style="width:100%;height:300px;background:#060e1c;border-radius:4px;display:block;">
              <defs>
                <marker id="arr-shue" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto">
                  <path d="M0,0 L6,3 L0,6 Z" fill="#2dd4a0"/>
                </marker>
                <clipPath id="sclip"><rect x="0" y="0" width="400" height="320"/></clipPath>
              </defs>
              <g id="shue-grid"></g>
              <!-- Axes -->
              <line x1="10" y1="160" x2="390" y2="160" stroke="#1a3358" stroke-width="1"/>
              <line x1="200" y1="10" x2="200" y2="310" stroke="#1a3358" stroke-width="1"/>
              <!-- Axis labels -->
              <text x="374" y="155" fill="#6a88b0" font-size="10" font-family="IBM Plex Mono">+X</text>
              <text x="182" y="22"  fill="#6a88b0" font-size="10" font-family="IBM Plex Mono">+Z</text>
              <text x="15"  y="155" fill="#6a88b0" font-size="10" font-family="IBM Plex Mono">‚àíX</text>
              <text x="182" y="308" fill="#6a88b0" font-size="10" font-family="IBM Plex Mono">‚àíZ</text>
              <text x="340" y="174" fill="#6a88b0" font-size="9"  font-family="IBM Plex Mono">‚òÄ Sun</text>
              <text x="204" y="157" fill="#3a5070" font-size="9"  font-family="IBM Plex Mono">0</text>
              <!-- Shue magnetopause path -->
              <path id="shue-path" d="" fill="rgba(45,212,160,.07)" stroke="#2dd4a0" stroke-width="2" clip-path="url(#sclip)"/>
              <!-- Nightside tail-cap -->
              <line id="shue-tailcap" x1="80" y1="20" x2="80" y2="300" stroke="#38c0ff" stroke-width="1.5" stroke-dasharray="5,4"/>
              <text id="shue-tailcap-lbl" x="84" y="100" fill="#38c0ff" font-size="9" font-family="IBM Plex Mono">X_tail</text>
              <!-- Earth -->
              <circle cx="200" cy="160" r="5" fill="#1a88d4"/>
              <!-- Inner boundary sphere -->
              <circle id="inner-shue" cx="200" cy="160" r="10" fill="rgba(255,90,90,.07)" stroke="#ff5a5a" stroke-width="1" stroke-dasharray="3,3"/>
              <text id="inner-shue-lbl" x="215" y="145" fill="#ff5a5a" font-size="9" font-family="IBM Plex Mono">R_in=2RE</text>
              <!-- r‚ÇÄ annotation arrow: Earth ‚Üí subsolar point -->
              <line id="shue-r0-line" x1="200" y1="160" x2="243" y2="160" stroke="#ffd04b" stroke-width="1" stroke-dasharray="3,3" marker-end="url(#arr-shue)"/>
              <text id="shue-r0-lbl"  x="210" y="152" fill="#ffd04b" font-size="9" font-family="IBM Plex Mono">r‚ÇÄ</text>
              <!-- Flank annotation arrow: Earth ‚Üí terminator (X=0, Z=R_flank) -->
              <line id="shue-flank-line" x1="200" y1="160" x2="200" y2="90" stroke="#8b6ff7" stroke-width="1" stroke-dasharray="3,3" marker-end="url(#arr-shue)"/>
              <text id="shue-flank-lbl" x="204" y="115" fill="#8b6ff7" font-size="9" font-family="IBM Plex Mono">R_flk</text>
              <!-- Dynamic parameter readouts -->
              <text id="shue-svg-r0"    x="12" y="290" fill="#2dd4a0" font-size="9" font-family="IBM Plex Mono">r‚ÇÄ=8.56 RE</text>
              <text id="shue-svg-alpha" x="12" y="302" fill="#2dd4a0" font-size="9" font-family="IBM Plex Mono">Œ±=0.617</text>
              <text id="shue-svg-dst"   x="120" y="290" fill="#ff9a3c" font-size="9" font-family="IBM Plex Mono">Dst=‚àí142nT</text>
              <text id="shue-svg-pdyn"  x="120" y="302" fill="#ff9a3c" font-size="9" font-family="IBM Plex Mono">Pdyn=3.5nPa</text>
            </svg>
          </div>
          <div class="bnd-svg-footer">
            <span class="bnd-compare">Quiet (Dst=0, Pdyn=2): <span style="color:#fff;font-family:var(--font-mono);">r‚ÇÄ ‚âà 11.2 R<sub>E</sub></span></span>
            <span class="bnd-compare">Sep 2017 storm peak: <span style="color:var(--orange);font-family:var(--font-mono);">r‚ÇÄ ‚âà 8.6 R<sub>E</sub></span></span>
            <span class="bnd-compare">Extreme (Dst=‚àí300): <span style="color:var(--red);font-family:var(--font-mono);">r‚ÇÄ ‚âà 6.5 R<sub>E</sub></span></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>



<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PANEL 5 ‚Äî ELECTRIC FIELD MODEL
     Step 5 of 10 wizard.
     Handles: corotation E (always available), convection E models
     (Volland-Stern or Weimer), live SVG schematic, KW preview.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="panel-5" class="step-panel">
<div class="sect" id="s-efield">
  <div class="sect-hd" onclick="toggleSection('s-efield')">
    <div class="sect-icon" style="background:rgba(255,208,75,.12)">‚ö°</div>
    <div>
      <div class="sect-title">Electric Field Model</div>
      <div style="font-size:11px;color:var(--text-dim)">
        Magnetospheric electric fields that guide particle drift orbits.
        Maps to <code style="font-size:10px;">#ELECTRIC_FIELD</code> in AMPS_PARAM.in.
      </div>
    </div>
    <span class="sect-sub"><span class="tag tag-new">NEW ¬∑ Step 5</span></span>
    <span class="chevron">‚ñæ</span>
  </div>
  <div class="sect-body">

        <div class="infobox info-blue">
      <b>Why electric fields matter:</b> Particle drift depends on the <b>E√óB</b> electric drift, so the choice of E-field strongly affects access and cutoffs during storms.
      <br><b>Corotation E</b>: <code>E = -(Œ©√ór)√óB</code>. Baseline inner-magnetosphere co-rotation; typically keep <b>ON</b>.
      <br><b>Convection E</b>: <code>E = -‚àáŒ¶</code>. Solar-wind‚Äìdriven dawn‚Äìdusk transport; choose <b>one</b> model (Volland‚ÄìStern for robust Kp sweeps, or Weimer for IMF/solar-wind realism) or <b>None</b>.
      <br><b>Recommended:</b> use <b>Corotation + Convection</b> (additive) for most storm-time runs.
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION A: COROTATION ELECTRIC FIELD
         E_coro = -(œâ√ór)√óB ‚Äî Earth's corotation field.
         Nearly always included; computational cost is negligible.
         Maps to: COROTATION_E = YES | NO
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="subsection" style="margin-bottom:14px;">
      <div class="subsection-title">A ‚Äî Corotation Electric Field</div>
      <div style="display:flex;align-items:flex-start;gap:20px;flex-wrap:wrap;">
        <div style="flex:1;min-width:260px;">
          <p style="font-size:12px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            The corotation electric field <b>E = ‚àí(œâ√ór)√óB</b> maintains particles
            co-rotating with Earth inside the plasmasphere (L&nbsp;&lt;&nbsp;4‚Äì5).
            Disabling it is physically incorrect for trapped radiation-belt particles.
            <i>Strongly recommended: leave ON.</i>
          </p>
          <div class="tog" style="width:fit-content;">
            <button class="tog-btn on" id="ecoro-yes-btn" onclick="setCorotation(true)">
              ‚úì Include (recommended)
            </button>
            <button class="tog-btn" id="ecoro-no-btn" onclick="setCorotation(false)">
              Exclude
            </button>
          </div>
          <!-- Shown only when corotation is disabled ‚Äî physics warning -->
          <div id="ecoro-off-warn" class="infobox info-orange" style="display:none;margin-top:10px;font-size:11px;">
            ‚ö† <b>Warning:</b> Excluding corotation E is physically incorrect for inner
            magnetosphere / radiation belt particles. Use only for specialized tests
            (e.g. outer magnetosphere trajectories where corotation is negligible).
          </div>
        </div>
        <div style="background:var(--bg-inset);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;font-family:var(--font-mono);font-size:11px;min-width:200px;">
          <div style="color:var(--accent-bright);font-weight:700;margin-bottom:4px;">AMPS_PARAM.in</div>
          <span class="kw-key">COROTATION_E</span>
          <span class="kw-val" id="kw-efield-coro">YES</span>
          <span class="kw-comment">  ! corotation E</span>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION B: CONVECTION ELECTRIC FIELD ‚Äî model selector
         Options: VOLLAND_STERN | WEIMER | NONE
         Maps to: CONV_E_MODEL = ...
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="subsection">
      <div class="subsection-title">B ‚Äî Convection Electric Field</div>
      <p style="font-size:11px;color:var(--text-dim);margin-bottom:12px;line-height:1.6;">
        The large-scale dawn-dusk convection field drives inward particle transport.
        Choose a model based on your data availability and accuracy needs.
      </p>

      <!-- Convection model selector cards -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px;">

        <!-- Volland-Stern: simple Kp-driven, robust, recommended for most runs -->
        <div class="bnd-card sel" id="econv-volland-stern" onclick="setConvModel('VOLLAND_STERN')">
          <div style="font-size:22px;margin-bottom:5px;">üåÄ</div>
          <div style="font-size:13px;font-weight:700;color:#fff;margin-bottom:3px;">
            Volland‚ÄìStern <span style="font-size:9px;background:rgba(45,212,160,.2);color:var(--green);padding:1px 5px;border-radius:3px;">Recommended</span>
          </div>
          <div style="font-size:10px;color:var(--text-dim);line-height:1.5;">
            Potential Œ® = A¬∑r^Œ≥¬∑sin(œÜ). Driven by a single Kp index.
            Robust and well-tested. Kp can be auto-estimated from Dst.
          </div>
          <div style="margin-top:7px;font-family:var(--font-mono);font-size:10px;color:var(--accent-bright);background:rgba(0,0,0,.3);padding:4px 7px;border-radius:3px;">
            CONV_E_MODEL = VOLLAND_STERN
          </div>
        </div>

        <!-- Weimer 2005: IMF/solar-wind driven, event realism -->
        <div class="bnd-card" id="econv-weimer" onclick="setConvModel('WEIMER')">
          <div style="font-size:22px;margin-bottom:5px;">üåê</div>
          <div style="font-size:13px;font-weight:700;color:#fff;margin-bottom:3px;">
            Weimer (2005) <span style="font-size:9px;background:rgba(139,111,247,.18);color:var(--purple);padding:1px 5px;border-radius:3px;">Advanced</span>
          </div>
          <div style="font-size:10px;color:var(--text-dim);line-height:1.5;">
            Empirical potential pattern driven by IMF Bz, By, Pdyn, Vx ‚Äî
            same inputs as TS05. Better event-specific accuracy; auto-reads
            from Panel 3 drivers.
          </div>
          <div style="margin-top:7px;font-family:var(--font-mono);font-size:10px;color:var(--purple);background:rgba(0,0,0,.3);padding:4px 7px;border-radius:3px;">
            CONV_E_MODEL = WEIMER
          </div>
        </div>

        <!-- None: no convection field -->
        <div class="bnd-card" id="econv-none" onclick="setConvModel('NONE')">
          <div style="font-size:22px;margin-bottom:5px;">‚äò</div>
          <div style="font-size:13px;font-weight:700;color:#fff;margin-bottom:3px;">None</div>
          <div style="font-size:10px;color:var(--text-dim);line-height:1.5;">
            No convection field. Use only for outer-magnetosphere / GCR
            runs where the convection E is negligible
            (L &gt; ~8 R<sub>E</sub>).
          </div>
          <div style="margin-top:7px;font-family:var(--font-mono);font-size:10px;color:var(--text-dim);background:rgba(0,0,0,.3);padding:4px 7px;border-radius:3px;">
            CONV_E_MODEL = NONE
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Volland-Stern parameter sub-panel ‚îÄ‚îÄ -->
      <!-- Shown only when VOLLAND_STERN is selected.
           Key parameters:
             Kp    ‚Äî geomagnetic activity index (0‚Äì9), auto from Dst or manual
             Œ≥     ‚Äî shielding / flaring exponent (default 2.0)
             A(Kp) ‚Äî intensity coefficient (Maynard & Chen 1975 formula) -->
      <div id="vs-panel">
        <div style="font-size:11px;font-weight:700;color:var(--accent-bright);margin-bottom:10px;text-transform:uppercase;letter-spacing:.4px;">
          Volland‚ÄìStern Parameters
        </div>
        <div class="infobox info-blue" style="margin-bottom:10px;font-size:11px;">
          <b>Kp source:</b> Auto mode derives Kp from Dst using the
          empirical fit Kp ‚âà ‚àíDst/28 + 0.8 (Burton et al. 1975 inverse).
          Override with manual entry if you have a measured Kp value.
          <br/><br/>
          <b>Œ≥ (shielding exponent):</b> Controls how sharply the potential
          drops at the plasmapause. Default Œ≥ = 2.0 (Stern 1975).
          Values 1.5‚Äì3.0 are physically reasonable.
        </div>

        <!-- Kp mode toggle: auto (from Dst) or manual -->
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;flex-wrap:wrap;">
          <span style="font-size:11px;color:var(--text-dim);">Kp source:</span>
          <div class="tog" style="width:fit-content;">
            <button class="tog-btn on" id="vs-kp-auto-btn" onclick="setVsKpMode('auto')">
              üîÑ Auto from Dst
            </button>
            <button class="tog-btn" id="vs-kp-man-btn" onclick="setVsKpMode('manual')">
              ‚úè Manual entry
            </button>
          </div>
        </div>

        <!-- Auto Kp display row -->
        <div id="vs-kp-auto-row" style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
          <span style="font-size:11px;color:var(--text-dim);">
            Kp auto-derived from Dst (Panel 3):
          </span>
          <span style="font-family:var(--font-mono);font-size:14px;font-weight:700;color:var(--green);" id="vs-kp-auto-display">5.0</span>
          <span id="vs-kp-status" style="font-size:10px;color:var(--orange);">üü° Moderate activity</span>
        </div>

        <!-- Manual Kp entry row (hidden in auto mode) -->
        <div id="vs-kp-manual-row" style="display:none;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
          <div class="field" style="max-width:200px;">
            <label>Kp <span class="unit">[0‚Äì9]</span> <span class="req">*</span></label>
            <input id="vs-kp-input" type="number" value="5" step="0.1" min="0" max="9"
              oninput="vsParamChange()" style="font-family:var(--font-mono);font-size:13px;"/>
            <div class="hint">0 = very quiet ¬∑ 3 = moderate ¬∑ 5 = active ¬∑ 7+ = storm</div>
          </div>
          <span id="vs-kp-status" style="font-size:10px;margin-top:18px;"></span>
        </div>

        <div class="frow c4" style="margin-bottom:10px;">
          <div class="field">
            <label>Œ≥ ‚Äî shielding exponent</label>
            <input id="vs-gamma" type="number" value="2.0" step="0.1" min="1.5" max="3.0"
              oninput="vsParamChange()"/>
            <div class="hint">Default 2.0 (Stern 1975). Range: 1.5‚Äì3.0.</div>
          </div>
          <div class="field">
            <label>A(Kp) <span class="unit">[kV/R<sub>E</sub><sup>Œ≥</sup>]</span></label>
            <div style="font-family:var(--font-mono);font-size:14px;font-weight:700;color:var(--yellow);
              padding:6px 8px;background:var(--bg-inset);border:1px solid var(--border);
              border-radius:var(--radius);">
              <span id="vs-a-display">0.0450</span>
            </div>
            <div class="hint">Auto-computed via Maynard &amp; Chen (1975):<br/>
              A = 0.045 / (1 ‚àí 0.159Kp + 0.0093Kp¬≤)¬≥</div>
          </div>
        </div>
      </div><!-- /vs-panel -->

      <!-- ‚îÄ‚îÄ Weimer 2005 parameter sub-panel ‚îÄ‚îÄ -->
      <!-- Shown only when WEIMER is selected.
           Auto mode: reads IMF Bz, By, Pdyn, Vx from Panel 3 (TS05 drivers).
           File mode: upload a pre-computed weimer_input.txt (time-series). -->
      <div id="weimer-panel" style="display:none;">
        <div style="font-size:11px;font-weight:700;color:var(--purple);margin-bottom:10px;text-transform:uppercase;letter-spacing:.4px;">
          Weimer (2005) Configuration
        </div>

        <div class="tog" style="width:fit-content;margin-bottom:12px;">
          <button class="tog-btn on" id="weimer-auto-btn" onclick="setWeimerMode('auto')">
            üîÑ Auto from TS05 drivers (Panel 3)
          </button>
          <button class="tog-btn" id="weimer-file-btn" onclick="setWeimerMode('file')">
            üìÅ Upload weimer_input.txt
          </button>
        </div>

        <!-- Auto panel: shows current TS05 driver values being used -->
        <div id="weimer-auto-panel">
          <div class="infobox info-blue" style="font-size:11px;margin-bottom:10px;">
            Weimer auto mode reads <b>IMF Bz, By, Pdyn, and Vx</b> from the
            TS05 drivers you entered in Panel 3. For time-series runs, these
            update at every FIELD_UPDATE_DT interval.
          </div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
            <div style="background:var(--bg-inset);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;">
              <div style="font-size:9px;color:var(--text-dim);">IMF Bz [nT]</div>
              <div style="font-family:var(--font-mono);font-size:14px;font-weight:700;color:var(--red);" id="weimer-bz-disp">-18.5</div>
            </div>
            <div style="background:var(--bg-inset);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;">
              <div style="font-size:9px;color:var(--text-dim);">IMF By [nT]</div>
              <div style="font-family:var(--font-mono);font-size:14px;font-weight:700;color:var(--accent-bright);" id="weimer-by-disp">3.2</div>
            </div>
            <div style="background:var(--bg-inset);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;">
              <div style="font-size:9px;color:var(--text-dim);">|Vx| [km/s]</div>
              <div style="font-family:var(--font-mono);font-size:14px;font-weight:700;color:var(--purple);" id="weimer-vx-disp">650</div>
            </div>
            <div style="background:var(--bg-inset);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;">
              <div style="font-size:9px;color:var(--text-dim);">Pdyn [nPa]</div>
              <div style="font-family:var(--font-mono);font-size:14px;font-weight:700;color:var(--orange);" id="weimer-pd-disp">3.50</div>
            </div>
          </div>
        </div>

        <!-- File upload panel -->
        <div id="weimer-file-panel" style="display:none;">
          <div class="dropzone" onclick="this.classList.toggle('loaded')">
            <div class="dz-icon">üìÑ</div>
            <div class="dz-primary">Drop weimer_input.txt here or click to browse</div>
            <div class="dz-sub">Format: YYYY MM DD HH mm  Bz  By  Vx  Pdyn (same cadence as ts05_driving.txt)</div>
          </div>
        </div>
      </div><!-- /weimer-panel -->
    </div><!-- /convection subsection -->

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         LIVE SCHEMATIC ‚Äî equipotential pattern sketch
         Redrawn by drawEfieldSchematic() whenever model or
         Kp changes. Shows corotation circles + convection pattern.
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div style="display:grid;grid-template-columns:1fr 220px;gap:16px;align-items:start;margin-top:14px;">
      <div>
        <!-- Keyword preview strip for AMPS_PARAM.in -->
        <div class="kw-strip">
<span class="kw-section">#ELECTRIC_FIELD</span>
<span class="kw-key">COROTATION_E</span>    <span class="kw-val" id="kw-efield-coro">YES</span>      <span class="kw-comment">  ! corotation = ‚àí(œâ√ór)√óB</span>
<span class="kw-key">CONV_E_MODEL</span>    <span class="kw-val" id="kw-efield-conv">VOLLAND_STERN</span><span class="kw-comment">  ! VOLLAND_STERN | WEIMER | NONE</span>
<span class="vs-kw-row"><span class="kw-key">VS_KP</span>           <span class="kw-val kw-auto" id="kw-vs-kp">AUTO</span>     <span class="kw-comment">  ! AUTO = derived from Dst</span>
</span><span class="vs-kw-row"><span class="kw-key">VS_GAMMA</span>        <span class="kw-val" id="kw-vs-gamma">2.0</span>      <span class="kw-comment">  ! shielding exponent</span>
</span><span class="vs-kw-row"><span class="kw-key">VS_A</span>            <span class="kw-val" id="kw-vs-a">0.0450</span>   <span class="kw-comment">  ! kV/RE^Œ≥  (Maynard &amp; Chen 1975)</span>
</span><span class="weimer-kw-row" style="display:none;"><span class="kw-key">WEIMER_DRIVE</span>    <span class="kw-val">AUTO</span>     <span class="kw-comment">  ! from TS05 drivers</span>
</span></div>
      </div>

      <!-- SVG equipotential schematic (200√ó200 canvas) -->
      <div style="background:var(--bg-inset);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;">
        <div style="background:rgba(255,208,75,.08);border-bottom:1px solid var(--border);padding:6px 10px;font-size:10px;font-weight:700;color:var(--yellow);letter-spacing:.3px;">
          E-field equipotentials <span style="font-weight:400;color:var(--text-dim);">schematic</span>
        </div>
        <svg id="efield-svg" viewBox="0 0 200 200"
          style="width:100%;height:200px;background:#060e1c;display:block;">
          <!-- dynamically populated by drawEfieldSchematic() -->
        </svg>
      </div>
    </div>

  </div><!-- /sect-body -->
</div><!-- /sect -->
</div><!-- /panel-5 -->

<div id="panel-6" class="step-panel">
<div class="sect" id="s-temporal">
  <div class="sect-hd" onclick="toggleSection('s-temporal')">
    <div class="sect-icon" style="background:rgba(255,208,75,.12)">&#8987;</div>
    <div><div class="sect-title">Temporal Variability of the Background Field</div>
    <div style="font-size:11px;color:var(--text-dim)">How TS05 parameters evolve during the simulation. Maps to TEMPORAL_MODE in AMPS_PARAM.in.</div></div>
    <span class="sect-sub"><span class="tag tag-new">Step 6</span></span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="sect-body">
    <div class="infobox info-blue"><b>Why this matters:</b> Mid-latitude cutoff rigidity drops 30&#8211;50% during a storm main phase. Steady-state captures a single snapshot. Time-Series tracks storm evolution needed for instrument comparison.</div>
    <div class="temp-cards">
      <div class="temp-card" id="tc-steady" data-mode="STEADY_STATE" onclick="setTempMode('STEADY_STATE')">
        <div class="tc-icon">&#9889;</div><div class="tc-title">Steady-State</div>
        <div class="tc-desc">Single epoch snapshot. Field fixed at TS05 scalars from Panel 3. Fastest; best for cutoff maps and sweeps.</div>
        <div class="tc-badge"><span class="oc-badge badge-green">STEADY_STATE</span></div>
      </div>
      <div class="temp-card sel" id="tc-series" data-mode="TIME_SERIES" onclick="setTempMode('TIME_SERIES')">
        <div class="tc-icon">&#128200;</div><div class="tc-title">Time-Series</div>
        <div class="tc-desc">Field updated every &#916;t min from OMNIWeb auto-fetch or ts05_driving.txt. Required for storm-phase validation.</div>
        <div class="tc-badge"><span class="oc-badge badge-blue">TIME_SERIES</span></div>
      </div>
      <div class="temp-card disabled" id="tc-coupled" data-mode="COUPLED_MHD">
        <div class="tc-icon">&#128260;</div><div class="tc-title">Coupled MHD <span class="tag tag-exp">Year 2</span></div>
        <div class="tc-desc">Self-consistent BATS-R-US/GAMERA magnetosphere. 10&#215; resources. Not yet available ‚Äî coming 2026.</div>
        <div class="tc-badge"><span class="oc-badge badge-purple">COUPLED_MHD ‚Äî 2026</span></div>
      </div>
    </div>
    <!-- TIME-SERIES SUB-FORM: shown only when Time-Series mode is selected -->
    <div id="ts-form" style="border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;background:var(--bg-mid);">
      <div class="hlabel">
        <h4>Time-Series Event Window &amp; Cadence</h4>
        <span class="tag tag-new">Active</span>
      </div>

      <div class="frow c4">
        <div class="field">
          <label>Event Start <span class="req">*</span></label>
          <input id="event-start" type="datetime-local" value="2017-09-07T00:00" oninput="liveUpdate()"/>
          <div class="hint">UTC. Maps to <code>EVENT_START</code> in AMPS_PARAM.in</div>
        </div>
        <div class="field">
          <label>Event End <span class="req">*</span></label>
          <input id="event-end" type="datetime-local" value="2017-09-10T20:00" oninput="liveUpdate()"/>
          <div class="hint">UTC. Maps to <code>EVENT_END</code></div>
        </div>
        <div class="field">
          <label>Field Update Œît <span class="unit">[min]</span></label>
          <input id="field-update-dt" type="number" value="5" min="1" max="60" oninput="checkDtPair()"/>
          <div class="hint">TS05 refresh cadence. <code>FIELD_UPDATE_DT</code>. Recommend ‚â§5 min during storms.</div>
        </div>
        <div class="field">
          <label>Particle Inject Œît <span class="unit">[min]</span></label>
          <input id="inject-dt" type="number" value="30" min="5" max="240" oninput="checkDtPair()"/>
          <div class="hint">New particle batch frequency. <code>INJECT_DT</code>. Must be ‚â• Field Update Œît.</div>
        </div>
      </div>

      <div id="dt-warn" class="infobox info-orange" style="display:none;">‚ö† Inject Œît must be ‚â• Field Update Œît ‚Äî particles can only be injected after a field update.</div>

      <!-- FIELD UPDATE VISUALIZATION -->
      <div class="field-update-viz">
        <div style="font-size:11px;font-weight:700;color:var(--accent-bright);margin-bottom:8px;">
          üóÇÔ∏è How time-series field updating works in AMPS
        </div>
        <div class="fu-timeline" id="ts-timeline">
          <div class="fu-axis"></div>
          <!-- TS05 field update ticks every 5 min -->
          <div class="fu-tick" style="left:0%"></div><div class="fu-tick" style="left:10%"></div>
          <div class="fu-tick" style="left:20%"></div><div class="fu-tick" style="left:30%"></div>
          <div class="fu-tick" style="left:40%"></div><div class="fu-tick" style="left:50%"></div>
          <div class="fu-tick" style="left:60%"></div><div class="fu-tick" style="left:70%"></div>
          <div class="fu-tick" style="left:80%"></div><div class="fu-tick" style="left:90%"></div>
          <div class="fu-tick" style="left:100%"></div>
          <!-- Particle injection events every 30 min -->
          <div class="fu-particle" style="left:0%">üöÄ</div>
          <div class="fu-particle" style="left:50%">üöÄ</div>
          <div class="fu-particle" style="left:100%">üöÄ</div>
          <div class="fu-label" style="left:0%">t=0</div>
          <div class="fu-label" style="left:25%">+12.5 min</div>
          <div class="fu-label" style="left:50%">+25 min</div>
          <div class="fu-label" style="left:100%">+50 min</div>
        </div>
        <div class="fu-legend">
          <div class="fu-leg"><div class="fu-dot" style="background:var(--accent)"></div>TS05 field refresh every 5 min (FIELD_UPDATE_DT)</div>
          <div class="fu-leg"><div class="fu-dot" style="background:var(--orange)"></div>New particle batch injected every 30 min (INJECT_DT)</div>
          <div class="fu-leg"><div class="fu-dot" style="background:var(--text-dim)"></div>Particles propagated in quasi-static field snapshot between refreshes</div>
        </div>
      </div>

      <!-- TS05 DRIVING DATA SOURCE -->
      <div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px;text-transform:uppercase;letter-spacing:.4px;">TS05 Driving Data Source</div>
      <div class="tog" id="ts-source-tog">
        <button class="tog-btn on" id="ts-omni-btn" onclick="setTsSource(this,'omni')">üåê Auto-fetch (OMNIWeb)</button>
        <button class="tog-btn"    id="ts-file-btn"   onclick="setTsSource(this,'file')">üìÅ Upload ts05_driving.txt</button>
        <button class="tog-btn"    id="ts-scalar-btn" onclick="setTsSource(this,'scalar')">üìå Scalar (all steps)</button>
      </div>

      <!-- OMNIWEB AUTO-FETCH PANEL -->
      <div id="omni-panel" class="omni-widget">
        <div class="omni-title">üåê OMNIWeb + WDC Kyoto Auto-Fetch Pipeline</div>
        <div class="omni-steps">
          <div class="omni-step">
            <div class="os-num done" id="os-1">1</div>
            <span>Query <code style="font-family:var(--mono);font-size:10px;background:rgba(0,0,0,.3);padding:0 3px;">omniweb.gsfc.nasa.gov</code> for 1-min OMNI SW: Bz, By, Bx (GSM), Pdyn, Vx, Nsw</span>
          </div>
          <div class="omni-step">
            <div class="os-num done" id="os-2">2</div>
            <span>Query <code style="font-family:var(--mono);font-size:10px;background:rgba(0,0,0,.3);padding:0 3px;">wdc.kugi.kyoto-u.ac.jp</code> for hourly Dst or 1-min Sym-H proxy</span>
          </div>
          <div class="omni-step">
            <div class="os-num" id="os-3">3</div>
            <span style="color:var(--text-dim);">Merge streams ‚Üí fill gaps ‚Üí write ts05_driving.txt to run staging directory</span>
          </div>
          <div class="omni-step">
            <div class="os-num pending" id="os-4">4</div>
            <span style="color:var(--text-dim);">Display data summary for user confirmation before HPC dispatch</span>
          </div>
        </div>

        <div class="frow c3">
          <div class="field">
            <label>Data cadence</label>
            <select id="omni-cadence">
              <option>1 min (OMNI 1-min)</option>
              <option selected>5 min (OMNI 5-min, recommended)</option>
              <option>1 hr (hourly, not recommended for storms)</option>
            </select>
            <div class="hint">Sets <code>ts05_driving.txt</code> row spacing. Recommended: ‚â§5 min for Dst gradients &gt;20 nT/hr.</div>
          </div>
          <div class="field">
            <label>Gap fill method</label>
            <select id="omni-gapfill">
              <option selected>Linear interpolation (gaps &lt; 30 min)</option>
              <option>Fill with FILL_VALUE (‚àí9999)</option>
              <option>Previous valid value (hold)</option>
            </select>
            <div class="hint">AMPS stops at <code>FILL_VALUE</code> rows; linear interpolation is safer.</div>
          </div>
          <div class="field">
            <label>Fallback for &lt;24h events</label>
            <select id="omni-fallback">
              <option selected>DSCOVR L1 / ACE L2 (~15 min latency)</option>
              <option>OMNI real-time (1‚Äì4 hr latency)</option>
            </select>
            <div class="hint">OMNI has ~1‚Äì24 hr latency. Recent events need DSCOVR/ACE.</div>
          </div>
        </div>

        <div class="omni-status" id="omni-status">
          <span class="ok">‚úì Ready to fetch</span>&nbsp;&nbsp;Time range: <span style="color:#fff;">2017-09-07 00:00 ‚Üí 2017-09-10 20:00 UTC</span><br/>
          Estimated rows: <span style="color:#fff;">~1,056 rows @ 5 min cadence</span>&nbsp;¬∑&nbsp;
          <span class="warn">‚ö† Note: OMNI data gap 2017-09-10 19:00‚Äì19:30 UTC ‚Äî gap-fill will apply</span>
        </div>

        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
          <button class="btn-primary" style="font-size:12px;padding:8px 18px;" onclick="simulateOmniFetch()">üåê Fetch Now &amp; Preview Data</button>
          <button class="btn-secondary" style="font-size:11px;padding:6px 12px;" onclick="simulateOmniFetch()">üîÑ Re-fetch</button>
          <span style="font-size:10px;color:var(--text-dim);">Triggers OMNIWeb + Kyoto queries at submission</span>
        </div>

        <!-- DATA PREVIEW TABLE -->
        <div style="overflow-x:auto;">
          <table class="ts05-table">
            <tr><th>YYYY MM DD HH mm</th><th class="c-dst">Dst[nT]</th><th class="c-pdyn">Pdyn[nPa]</th><th class="c-bz">Bz[nT]</th><th class="c-vx">Vx[km/s]</th><th class="c-nsw">Nsw[cm‚Åª¬≥]</th><th class="c-by">By[nT]</th></tr>
            <tr><td style="font-family:var(--mono)">2017 09 07 00 00</td><td class="c-dst">-15.0</td><td class="c-pdyn">2.1</td><td class="c-bz">-2.5</td><td class="c-vx">-420</td><td class="c-nsw">6.8</td><td class="c-by">1.2</td></tr>
            <tr><td style="font-family:var(--mono)">2017 09 07 23 30</td><td class="c-dst">-142.0</td><td class="c-pdyn">3.5</td><td class="c-bz">-18.5</td><td class="c-vx">-650</td><td class="c-nsw">12.0</td><td class="c-by">3.2</td></tr>
            <tr><td style="font-family:var(--mono);color:var(--text-dim)" colspan="7">‚Ä¶ 1,052 more rows ‚Ä¶</td></tr>
            <tr><td style="font-family:var(--mono)">2017 09 10 20 00</td><td class="c-dst">-45.0</td><td class="c-pdyn">1.8</td><td class="c-bz">+3.2</td><td class="c-vx">-380</td><td class="c-nsw">4.5</td><td class="c-by">2.1</td></tr>
          </table>
        </div>
      </div><!-- /omni-panel -->

      <!-- FILE UPLOAD PANEL -->
      <div id="file-panel" style="display:none;margin-top:12px;">
        <div class="infobox info-blue">
          <b>ts05_driving.txt column specification:</b><br/>
          <code>YYYY MM DD HH mm  Dst[nT]  Pdyn[nPa]  Bz[nT]  Vx[km/s]  Nsw[cm‚Åª¬≥]  By[nT](opt)  Bx[nT](opt)</code><br/>
          Comment lines start with <code>#</code>. Whitespace-delimited. Times must be monotonically increasing UTC.
        </div>
        <div class="dropzone" id="ts05-dropzone" onclick="this.classList.toggle('loaded')">
          <div class="dz-icon">üìÑ</div>
          <div class="dz-primary">Drop ts05_driving.txt here or click to browse</div>
          <div class="dz-sub">.txt ¬∑ .csv ¬∑ .dat ¬∑ max 50 MB</div>
        </div>
      </div>

      <!-- FORMAT REFERENCE -->
      <div class="fmt-diagram" style="margin-top:14px;">
        <div class="fmt-title"><div class="fmt-title-left"><span class="fmt-title-icon">üìÑ</span>ts05_driving.txt ‚Äî Format Reference</div><span class="fmt-sub">whitespace-delimited ASCII ¬∑ comment lines: #</span></div>
        <div class="fmt-sample">
          <span class="f-comment"># YYYY MM DD HH mm   Dst[nT]  Pdyn[nPa]  Bz[nT]  Vx[km/s]  Nsw[cm-3]  By[nT]  Bx[nT]</span><br>
          <span class="f-year">2017</span> <span class="f-mon">09</span> <span class="f-day">07</span> <span class="f-hr">23</span> <span class="f-min">30</span>&nbsp;&nbsp;<span class="f-dst">-142.0</span>&nbsp;&nbsp;<span class="f-pdyn">3.50</span>&nbsp;&nbsp;&nbsp;<span class="f-bz">-18.5</span>&nbsp;&nbsp;<span class="f-vx">-650.0</span>&nbsp;&nbsp;<span class="f-nsw">12.0</span>&nbsp;&nbsp;<span class="f-by">3.2</span>&nbsp;&nbsp;<span class="f-bx">0.0</span>
        </div>
        <div class="fmt-legend">
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#38c0ff"></div><div><div class="fmt-leg-name">YYYY MM DD HH mm</div><div class="fmt-leg-desc">UTC timestamp (5 cols)</div></div></div>
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#ff5a5a"></div><div><div class="fmt-leg-name">Dst [nT]</div><div class="fmt-leg-desc">Ring current index</div></div></div>
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#ff9a3c"></div><div><div class="fmt-leg-name">Pdyn [nPa]</div><div class="fmt-leg-desc">Solar wind dynamic pressure</div></div></div>
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#ff6b6b"></div><div><div class="fmt-leg-name">Bz [nT GSM]</div><div class="fmt-leg-desc">IMF southward component</div></div></div>
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#c5a0ff"></div><div><div class="fmt-leg-name">Vx [km/s]</div><div class="fmt-leg-desc">SW bulk velocity (‚àí)</div></div></div>
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#8bb4ff"></div><div><div class="fmt-leg-name">Nsw [cm‚Åª¬≥]</div><div class="fmt-leg-desc">Proton number density</div></div></div>
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#78d4ff"></div><div><div class="fmt-leg-name">By, Bx [nT]</div><div class="fmt-leg-desc">IMF Y,X optional columns</div></div></div>
        </div>
      </div>
    </div><!-- /ts-form -->
  </div>
</div>
</div>


<div id="panel-7" class="step-panel">
<div class="sect" id="s-spectrum">
  <div class="sect-hd" onclick="toggleSection('s-spectrum')">
    <div class="sect-icon" style="background:rgba(45,212,160,.12)">&#128202;</div>
    <div><div class="sect-title">Particle Source Spectrum / Boundary Condition</div>
    <div style="font-size:11px;color:var(--text-dim)">SEP energy spectrum injected at the outer boundary. Maps to #SPECTRUM in AMPS_PARAM.in.</div></div>
    <span class="sect-sub"><span class="tag tag-new">Step 7</span></span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="sect-body">

    <!--
      NOTE (UI help location):
      Spectrum model documentation is now presented in the global Help menu under:
        Help ‚Üí Physics Models ‚Üí Particle Spectrum Models
      This keeps all physics-model documentation in one consistent place.
    -->

	    <!--
	      IMPORTANT:
	      Do NOT close .sect-body/.sect here.
	      The spectrum model cards and parameter forms below must remain inside
	      this .sect-body container so that Step 7 renders correctly.
	    -->

    <div class="opt-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));">
      <div class="opt-card sel spec-card" id="sc-pl" onclick="setSpec('POWER_LAW',this)"><div class="oc-icon">&#128201;</div>
        <div class="oc-title">Power Law</div>
        <div class="oc-sub">J(E) = J&#8320;(E/E&#8320;)^&#8722;&#947;. Widely used for SEP and quiet-time GCR studies.</div>
        <span class="oc-badge badge-green">POWER_LAW</span></div>
      <div class="opt-card spec-card" id="sc-plc" onclick="setSpec('POWER_LAW_CUTOFF',this)"><div class="oc-icon">&#128200;</div>
        <div class="oc-title">Power Law + Exp Cutoff</div>
        <div class="oc-sub">J(E) = J&#8320;(E/E&#8320;)^&#8722;&#947;exp(&#8722;E/E&#8337;). High-energy rolloff for relativistic events.</div>
        <span class="oc-badge badge-purple">PL_CUTOFF</span></div>
      <div class="opt-card spec-card" id="sc-lis" onclick="setSpec('LIS_FORCE_FIELD',this)"><div class="oc-icon">&#9728;</div>
        <div class="oc-title">LIS + Force-Field</div>
        <div class="oc-sub">Local Interstellar Spectrum with solar modulation &#966; [MV]. Standard for GCR modeling.</div>
        <span class="oc-badge badge-cyan">FORCE_FIELD</span></div>
      <div class="opt-card spec-card" id="sc-band" onclick="setSpec('BAND',this)"><div class="oc-icon">&#12316;</div>
        <div class="oc-title">Band Function</div>
        <div class="oc-sub">Broken power law with spectral softening above E&#8320; (Band 1993). Better for large events.</div>
        <span class="oc-badge badge-blue">BAND_FUNCTION</span></div>
      <div class="opt-card spec-card" id="sc-table" onclick="setSpec('TABLE',this)"><div class="oc-icon">&#128203;</div>
        <div class="oc-title">Table Upload</div>
        <div class="oc-sub">Upload measured spectrum from GOES-15/16 or EPAM as 2-column ASCII.</div>
        <span class="oc-badge badge-orange">TABLE FILE</span></div>
    </div>
    <div id="pl-form" class="subsection">
      <div class="subsection-title">Power Law: J(E) = J&#8320; &middot; (E / E&#8320;)^&#8722;&#947;</div>
      <div class="frow c3">
        <div class="field"><label>J&#8320; <span class="unit">[p/cm&#178;/s/sr/(MeV/n)]</span></label>
          <input id="spec-j0" type="number" value="10000" step="100" min="0.001" oninput="drawSpec()"/>
          <div class="hint">Flux normalization at pivot energy E&#8320;.</div></div>
        <div class="field"><label>&#947; ‚Äî Spectral index</label>
          <input id="spec-gamma" type="number" value="3.5" step="0.1" min="0.5" max="10" oninput="drawSpec()"/>
          <div class="hint">Typical SEP: 2&#8211;5. Harder spectra (&#947;&lt;3) penetrate deeper into the magnetosphere.</div></div>
        <div class="field"><label>E&#8320; ‚Äî Pivot <span class="unit">[MeV/n]</span></label>
          <input id="spec-e0" type="number" value="10" step="1" min="0.1" oninput="drawSpec()"/>
          <div class="hint">Reference energy. Convention: 10 MeV/n.</div></div>
      </div>
    </div>
    <div id="plc-form" style="display:none;" class="subsection">
      <div class="subsection-title">Power Law + Exponential Cutoff: J(E) = J&#8320; &middot; (E / E&#8320;)^&#8722;&#947; &middot; exp(&#8722;E / E&#8337;)</div>
      <div class="infobox info-blue">High-energy exponential rolloff captures the finite acceleration energy in shock-associated SEP events. E&#8337; typically 100‚Äì1000 MeV for large gradual SEPs.</div>
      <div class="frow c4">
        <div class="field"><label>J&#8320; <span class="unit">[p/cm&#178;/s/sr/(MeV/n)]</span></label>
          <input id="plc-j0" type="number" value="10000" step="100" min="0.001" oninput="drawSpec()"/>
          <div class="hint">Flux normalization at pivot energy E&#8320;.</div></div>
        <div class="field"><label>&#947; ‚Äî Spectral index</label>
          <input id="plc-gamma" type="number" value="3.5" step="0.1" min="0.5" max="10" oninput="drawSpec()"/>
          <div class="hint">Low-energy power-law slope (same as simple PL).</div></div>
        <div class="field"><label>E&#8320; ‚Äî Pivot <span class="unit">[MeV/n]</span></label>
          <input id="plc-e0" type="number" value="10" step="1" min="0.1" oninput="drawSpec()"/>
          <div class="hint">Reference energy. Convention: 10 MeV/n.</div></div>
        <div class="field"><label>E&#8337; ‚Äî Cutoff <span class="unit">[MeV/n]</span></label>
          <input id="spec-ec" type="number" value="500" step="50" min="10" oninput="drawSpec()"/>
          <div class="hint">Exponential e-folding energy. Typical: 200‚Äì1000 MeV.</div></div>
      </div>
    </div>
    <div id="lis-form" style="display:none;" class="subsection">
      <div class="subsection-title">Local Interstellar Spectrum (LIS) + Force-Field Solar Modulation</div>
      <div class="infobox info-blue">Gleeson-Axford force-field approximation: J(E,&#966;) = J<sub>LIS</sub>(E+&#966;) &middot; (E¬≤ + 2EM) / ((E+&#966;)¬≤ + 2(E+&#966;)M). Standard model for Galactic Cosmic Rays. &#966; = 550 MV ‚âà solar minimum; &#966; = 1200 MV ‚âà solar maximum.</div>
      <div class="frow c4">
        <div class="field"><label>J<sub>LIS</sub> <span class="unit">[p/cm&#178;/s/sr/(MeV/n)]</span></label>
          <input id="lis-j0" type="number" value="10000" step="100" min="0.001" oninput="drawSpec()"/>
          <div class="hint">LIS normalization (at E&#8320; in absence of modulation).</div></div>
        <div class="field"><label>&#947;<sub>LIS</sub> ‚Äî LIS index</label>
          <input id="lis-gamma" type="number" value="2.7" step="0.05" min="2.0" max="3.5" oninput="drawSpec()"/>
          <div class="hint">LIS power-law index. Typical GCR protons: 2.6‚Äì2.8.</div></div>
        <div class="field"><label>E&#8320; ‚Äî Pivot <span class="unit">[MeV/n]</span></label>
          <input id="lis-e0" type="number" value="10" step="1" min="0.1" oninput="drawSpec()"/>
          <div class="hint">Reference energy for LIS normalization.</div></div>
        <div class="field"><label>&#966; ‚Äî Modulation <span class="unit">[MV]</span></label>
          <input id="spec-phi" type="number" value="550" step="50" min="0" max="2000" oninput="drawSpec()"/>
          <div class="hint">Solar modulation potential. 400‚Äì700 MV = minimum; 1000‚Äì1400 MV = maximum.</div></div>
      </div>
    </div>
    <div id="band-form" style="display:none;" class="subsection">
      <div class="subsection-title">Band Function: broken power law with e-folding</div>
      <div class="frow c4">
        <div class="field"><label>J&#8320;</label><input id="band-j0" type="number" value="10000" step="100" oninput="drawSpec()"/></div>
        <div class="field"><label>&#947;&#8321; ‚Äî low-E slope</label><input id="band-gamma1" type="number" value="3.5" step="0.1" oninput="drawSpec()"/><div class="hint">Below E<sub>break</sub></div></div>
        <div class="field"><label>&#947;&#8322; ‚Äî high-E slope</label><input id="band-gamma2" type="number" value="1.5" step="0.1" oninput="drawSpec()"/><div class="hint">Above E<sub>break</sub></div></div>
        <div class="field"><label>E&#8320; <span class="unit">[MeV/n]</span></label><input id="band-e0" type="number" value="10" step="1" oninput="drawSpec()"/></div>
      </div>
    </div>
    <div id="table-form" style="display:none;" class="subsection">
      <div class="subsection-title">Table Upload ‚Äî sep_spectrum_H+.txt</div>
      <div class="infobox info-blue">Two-column whitespace-delimited ASCII: <code>E[MeV/n]   dJ/dE</code>. Min 5 points. Range must span E<sub>min</sub> to E<sub>max</sub>.</div>
      <div class="dropzone" id="spec-dropzone" onclick="this.classList.toggle('loaded')"><div class="dz-icon">&#128194;</div>
        <div class="dz-primary">Drop sep_spectrum_H+.txt or click to browse</div>
        <div class="dz-sub">2-col ASCII: E[MeV/n]  dJ/dE[p/cm&#178;/s/sr/(MeV/n)]</div></div>
    </div>
    <div class="spectrum-display">
      <div class="spec-title">Spectrum Preview &#8212; log J vs log E</div>
      <div class="spec-chart-wrap"><canvas id="spec-canvas" style="width:100%;height:160px;"></canvas></div>
      <div style="display:flex;gap:16px;font-size:10px;color:var(--text-dim);margin-top:8px;align-items:center;">
        <span>Energy range:</span>
        <input id="spec-emin" type="number" value="1" step="0.5" min="0.1" style="width:65px;padding:4px 6px;font-size:11px;background:var(--bg-inset);border:1px solid var(--border);color:var(--text);border-radius:4px;font-family:var(--font-mono);" oninput="drawSpec()"/>
        <span>to</span>
        <input id="spec-emax" type="number" value="1000" step="10" min="10" style="width:80px;padding:4px 6px;font-size:11px;background:var(--bg-inset);border:1px solid var(--border);color:var(--text);border-radius:4px;font-family:var(--font-mono);" oninput="drawSpec()"/>
        <span>MeV/n</span>
      </div>
    </div>
  </div>
</div>
</div>


<div id="panel-8" class="step-panel">
<div class="sect" id="s-output">
  <div class="sect-hd" onclick="toggleSection('s-output')">
    <div class="sect-icon" style="background:rgba(45,212,160,.12)">&#128205;</div>
    <div><div class="sect-title">Output Domain &#8212; Where to Compute Flux &amp; Cutoff Rigidity</div>
    <div style="font-size:11px;color:var(--text-dim)">Mode A: individual points &middot; Mode B: spacecraft trajectory &middot; Mode C: spherical shells</div></div>
    <span class="sect-sub"><span class="tag tag-new">Step 8</span></span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="sect-body">
    <div class="opt-grid c3">
      <div class="opt-card mode-card" id="mc-points" onclick="setMode('POINTS',this)"><div class="oc-icon">&#128204;</div>
        <div class="oc-title">Mode A &#8212; Individual Points</div>
        <div class="oc-sub">List of (lat, lon, alt) or GSM (X,Y,Z) locations. Up to 500 entries. Best for specific positions.</div>
        <span class="oc-badge badge-green">POINTS</span></div>
      <div class="opt-card sel mode-card" id="mc-traj" onclick="setMode('TRAJECTORY',this)"><div class="oc-icon">&#128760;</div>
        <div class="oc-title">Mode B &#8212; Spacecraft Trajectory</div>
        <div class="oc-sub">NAIRAS-format timestamped trajectory (Gregorian or MJD). Direct comparison with in situ data.</div>
        <span class="oc-badge badge-green">TRAJECTORY</span></div>
      <div class="opt-card mode-card" id="mc-shells" onclick="setMode('SHELLS',this)"><div class="oc-icon">&#127760;</div>
        <div class="oc-title">Mode C &#8212; Spherical Shells</div>
        <div class="oc-sub">Global 2D cutoff maps at 1&#8211;5 altitudes. World maps and SAA visualization.</div>
        <span class="oc-badge badge-green">SHELLS</span></div>
    </div>
    <div id="panel-mode-b">
      <div class="frow c2" style="margin-bottom:14px;">
        <div class="field"><label>Coordinate System</label>
          <select id="coord-sys">
            <option value="GEO" selected>GEO (default &#8212; NAIRAS native)</option>
            <option value="GSM">GSM</option><option value="SM">SM</option>
          </select>
        </div>
        <div class="field"><label>Flux Output Interval <span class="unit">[min]</span></label>
          <input id="flux-dt" type="number" value="1.0" step="0.5" min="0.1" max="60" oninput="liveUpdate()"/>
          <div class="hint">1 min matches Van Allen Probe spin averaging. Maps to FLUX_DT.</div>
        </div>
      </div>
      <div class="dropzone" id="traj-dropzone" onclick="loadTrajExample()">
        <div class="dz-icon">&#128760;</div>
        <div class="dz-primary">Drop trajectory file or click to load Sep 2017 Van Allen Probe A example</div>
        <div class="dz-sub">NAIRAS Gregorian (9 cols) or MJD (4 cols) &middot; .txt / .csv / .dat</div>
      </div>
      <div id="traj-preview-panel" style="display:none;margin-top:12px;">
        <div class="hlabel"><h4>Parsed Trajectory Preview</h4><span style="font-size:11px;color:var(--green);">&#10003; All validation checks passed</span></div>
        <div style="overflow-x:auto;">
        <table class="traj-table">
          <tr><th>YYYY</th><th>MM DD</th><th>HH mm ss.s</th><th>Lat [&#176;]</th><th>Lon [&#176;]</th><th>Alt [km]</th><th>OK?</th></tr>
          <tr><td class="c-year">2017</td><td class="c-date">09 07</td><td class="c-time">00 00 00.0</td><td class="c-lat">-12.75</td><td class="c-lon">140.33</td><td class="c-alt">21045.8</td><td class="c-ok">&#10003;</td></tr>
          <tr><td class="c-year">2017</td><td class="c-date">09 07</td><td class="c-time">00 01 00.0</td><td class="c-lat">-12.48</td><td class="c-lon">141.92</td><td class="c-alt">21089.4</td><td class="c-ok">&#10003;</td></tr>
          <tr><td style="font-family:var(--font-mono);color:var(--text-muted)" colspan="7" style="text-align:center">&#8230; 14,408 more rows &#8230;</td></tr>
          <tr><td class="c-year">2017</td><td class="c-date">09 10</td><td class="c-time">19 59 00.0</td><td class="c-lat">+62.31</td><td class="c-lon">-94.20</td><td class="c-alt">36418.5</td><td class="c-ok">&#10003;</td></tr>
        </table>
        </div>
        <table class="val-table" style="margin-top:8px;">
          <tr><th>Check</th><th>Result</th></tr>
          <tr><td>Row count (14,412)</td><td class="vt-pass">&#10003; PASS</td></tr>
          <tr><td>Monotonic timestamps</td><td class="vt-pass">&#10003; PASS</td></tr>
          <tr><td>Latitude range (&#8722;65.3&#176; to +65.3&#176;)</td><td class="vt-pass">&#10003; PASS</td></tr>
          <tr><td>Altitude range (21,000&#8211;36,500 km)</td><td class="vt-pass">&#10003; PASS</td></tr>
          <tr><td>Overlaps TS05 event window</td><td class="vt-pass">&#10003; PASS</td></tr>
          <tr><td>No duplicate timestamps</td><td class="vt-pass">&#10003; PASS</td></tr>
          <tr><td>Gregorian (9-col) format</td><td class="vt-pass">&#10003; PASS</td></tr>
        </table>
      </div>
      <div class="fmt-diagram" style="margin-top:12px;">
        <div class="fmt-title"><div class="fmt-title-left"><span class="fmt-title-icon">&#128196;</span>NAIRAS Trajectory Format &#8212; Gregorian</div><span class="fmt-sub">9 cols whitespace-delimited &middot; UTC &middot; comment: #</span></div>
        <div class="fmt-sample">
          <span class="f-comment"># YYYY MM DD HH mm ss.s   Lat[deg]  Lon[deg]  Alt[km]</span><br>
          <span class="f-year">2017</span> <span class="f-mon">09</span> <span class="f-day">10</span> <span class="f-hr">16</span> <span class="f-min">00</span> <span class="f-sec">00.0</span>  <span class="f-lat">-12.75</span>  <span class="f-lon">140.33</span>  <span class="f-alt">21045.8</span>
        </div>
        <div class="fmt-legend">
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#38c0ff"></div><div><div class="fmt-leg-name">YYYY</div><div class="fmt-leg-desc">4-digit year</div></div></div>
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#5aeacf"></div><div><div class="fmt-leg-name">MM DD</div><div class="fmt-leg-desc">Month, day</div></div></div>
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#a8d8ff"></div><div><div class="fmt-leg-name">HH mm</div><div class="fmt-leg-desc">UTC hour, minute</div></div></div>
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#c5e8ff"></div><div><div class="fmt-leg-name">ss.s</div><div class="fmt-leg-desc">Seconds (sub-second)</div></div></div>
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#ff9a3c"></div><div><div class="fmt-leg-name">Lat [&#176;]</div><div class="fmt-leg-desc">Geocentric &#8722;90 to +90</div></div></div>
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#ffb866"></div><div><div class="fmt-leg-name">Lon [&#176;]</div><div class="fmt-leg-desc">East longitude &#8722;180 to +180</div></div></div>
          <div class="fmt-leg-item"><div class="fmt-leg-swatch" style="background:#ffd04b"></div><div><div class="fmt-leg-name">Alt [km]</div><div class="fmt-leg-desc">Altitude above WGS-84</div></div></div>
        </div>
      </div>
    </div>
    <div id="panel-mode-a" style="display:none;" class="subsection">
      <div class="subsection-title">Individual Points</div>
      <div class="infobox info-blue">Enter up to 500 (lat, lon, alt) points. One per line: <code>lat lon alt_km</code>. Or use GSM mode: <code>X Y Z RE</code>.</div>
      <div class="field"><label>Point List</label>
        <textarea rows="5" placeholder="51.5  -0.12  450.0&#10;28.5  -81.4  400.0&#10;&#8230;"></textarea></div>
    </div>
    <div id="panel-mode-c" style="display:none;" class="subsection">
      <div class="subsection-title">Spherical Shell Configuration</div>
      <div class="frow c3">
        <div class="field"><label>Number of Shells</label><select id="shell-count"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
        <div class="field"><label>Shell 1 Altitude <span class="unit">[km]</span></label><input type="number" value="450" step="10"/><div class="hint">ISS orbit ~410 km, GPS ~20200 km</div></div>
        <div class="field"><label>Grid Resolution</label><select><option value="1">1&#176; &#215; 1&#176;</option><option value="2">2&#176; &#215; 2&#176;</option><option value="5">5&#176; &#215; 5&#176;</option></select></div>
      </div>
    </div>
  </div>
</div>
</div>


<div id="panel-9" class="step-panel">
<div class="sect" id="s-out-opts">
  <div class="sect-hd" onclick="toggleSection('s-out-opts')">
    <div class="sect-icon" style="background:rgba(26,136,212,.15)">&#9881;</div>
    <div><div class="sect-title">Output Options &#8212; Flux Type, Energy Bins, File Format</div>
    <div style="font-size:11px;color:var(--text-dim)">Maps to #OUTPUT_OPTIONS and ENERGY_BINS in AMPS_PARAM.in.</div></div>
    <span class="sect-sub"><span class="tag tag-new">Step 9</span></span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="sect-body">
    <div class="subsection">
      <div class="subsection-title">Flux Type</div>
      <div class="tog">
        <button class="tog-btn on flux-type-btn" data-type="DIFFERENTIAL" onclick="setFluxType('DIFFERENTIAL',this)">Differential &#8201; dJ/dE</button>
        <button class="tog-btn flux-type-btn" data-type="INTEGRAL" onclick="setFluxType('INTEGRAL',this)">Integral &#8201; J(&gt;E)</button>
        <button class="tog-btn flux-type-btn" data-type="BOTH" onclick="setFluxType('BOTH',this)">Both</button>
      </div>
      <div class="frow c2" style="margin-top:12px;">
        <div style="display:flex;align-items:center;gap:10px;font-size:12px;">
          <input id="output-cutoff" type="checkbox" checked style="width:14px;height:14px;accent-color:var(--accent);"/>
          <label for="output-cutoff" style="cursor:pointer;">Output cutoff rigidity maps <span class="tag tag-new">R<sub>c</sub></span></label>
        </div>
        <div style="display:flex;align-items:center;gap:10px;font-size:12px;">
          <input id="output-pitch" type="checkbox" style="width:14px;height:14px;accent-color:var(--accent);"/>
          <label for="output-pitch" style="cursor:pointer;">Output pitch angle distributions (PAD) <span class="tag tag-exp">large files</span></label>
        </div>
      </div>
    </div>
    <div class="subsection">
      <div class="hlabel"><h4>Energy Bins <span class="unit">[MeV/n]</span></h4>
        <div style="display:flex;gap:8px;align-items:center;">
          <select id="preset-bins" onchange="applyBinPreset(this.value)" style="font-size:11px;padding:4px 8px;background:var(--bg-inset);border:1px solid var(--border);color:var(--text);border-radius:4px;">
            <option value="">Load preset&#8230;</option>
            <option value="default">Default (7 bins)</option>
            <option value="fine">Fine LEP (16 bins)</option>
            <option value="goes">GOES-16 compatible (8 bins)</option>
            <option value="broad">Broad survey (4 bins)</option>
          </select>
        </div>
      </div>
      <div id="ebin-list"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
        <input id="new-bin-val" type="number" step="any" min="0.01" placeholder="Add bin [MeV/n]" style="width:160px;padding:6px 10px;font-size:11px;background:var(--bg-inset);border:1px solid var(--border);color:var(--text);border-radius:4px;font-family:var(--font-mono);"/>
        <button class="btn-secondary btn-sm" onclick="addBin()">+ Add Energy Bin</button>
        <span id="total-output-size" style="font-size:10px;color:var(--text-muted);margin-left:auto;">~5.6 GB output</span>
      </div>
    </div>
    <div class="subsection">
      <div class="subsection-title">Output File Format &amp; Coordinates</div>
      <div class="frow c3">
        <div class="field"><label>Output Format</label>
          <select id="output-format" onchange="liveUpdate()">
            <option value="NETCDF4" selected>NetCDF4 (recommended)</option>
            <option value="HDF5">HDF5</option>
            <option value="ASCII">ASCII (large files)</option>
          </select>
          <div class="hint">NetCDF4 compatible with Python/xarray and IDL.</div>
        </div>
        <div class="field"><label>Output Coordinates</label>
          <select id="output-coords" onchange="liveUpdate()">
            <option value="GEO" selected>GEO (geographic)</option>
            <option value="GSM">GSM</option>
            <option value="SM">SM (solar magnetic)</option>
          </select>
        </div>
        <div class="field"><label>Compression Level</label>
          <select id="compress-level">
            <option value="4" selected>4 (balanced)</option>
            <option value="1">1 (fast, large)</option>
            <option value="9">9 (slow, small)</option>
            <option value="0">0 (none)</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>
</div>


<div id="panel-10" class="step-panel">
<div class="sect" id="s-review">
  <div class="sect-hd" onclick="toggleSection('s-review')">
    <div class="sect-icon" style="background:rgba(45,212,160,.15)">&#128203;</div>
    <div><div class="sect-title">Review &amp; Submit</div>
    <div style="font-size:11px;color:var(--text-dim)">Final validation, AMPS_PARAM.in preview, file manifest, submission</div></div>
    <span class="sect-sub"><span class="tag tag-new">Step 10</span></span>
    <span class="chevron">&#9660;</span>
  </div>
  <div class="sect-body">
    <div class="hlabel"><h4>Validation Summary</h4><span id="review-summary" style="font-size:11px;"></span></div>
    <div class="review-block" id="review-checks"></div>
    <div class="hlabel" style="margin-top:16px;"><h4>File Manifest</h4></div>
    <div style="overflow-x:auto;margin-bottom:16px;">
    <table class="val-table">
      <tr><th>Filename</th><th>Role</th><th>Required?</th><th>Source</th><th>Status</th></tr>
      <tbody id="manifest-tbody"></tbody>
    </table>
    </div>
    <div class="hlabel"><h4>AMPS_PARAM.in &#8212; Generated Configuration File</h4>
      <div style="display:flex;gap:8px;">
        <button class="btn-secondary btn-sm" id="copy-param" onclick="copyParam()">&#128203; Copy</button>
        <button class="btn-secondary btn-sm" id="download-param" onclick="downloadParam()">&#8681; Download</button>
      </div>
    </div>
    <pre class="review-param-file" id="review-param" style="max-height:460px;overflow:auto;"></pre>
    <div style="margin-top:16px;padding:16px;background:rgba(45,212,160,.04);border:1px solid rgba(45,212,160,.2);border-radius:var(--radius-lg);text-align:center;">
      <div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px;">Ready to submit your run to CCMC?</div>
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:14px;">Estimated queue: <b style="color:var(--orange)">1&#8211;3 days</b> &middot; Compute cost: <b style="color:var(--orange)">~5,000 SBU</b> &middot; Notification will be sent to your PI email.</div>
      <button class="btn-primary" id="submit-btn-final" onclick="finalSubmit()" style="font-size:14px;padding:11px 32px;">&#128640; Submit Run to CCMC</button>
    </div>
  </div>
</div>
</div>

</div>

<div class="side-col">
  <div class="sb-card">
    <div class="sb-title">Configuration Summary</div>
    <div class="progress"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    <div style="font-size:10px;color:var(--text-dim);text-align:right;margin-bottom:8px;"><span id="progress-pct">0%</span> complete</div>
    <div class="sb-row"><div class="sb-k">Run name</div><div class="sb-v o" id="sb-run-name">(not set)</div></div>
    <div class="sb-row"><div class="sb-k">Species</div><div class="sb-v g" id="sb-species">H+ proton</div></div>
    <div class="sb-row"><div class="sb-k">Field model</div><div class="sb-v g" id="sb-field-model">TS05</div></div>
    <div class="sb-row"><div class="sb-k">Boundary</div><div class="sb-v g" id="sb-boundary">Shue 1998</div></div>
    <div class="sb-row"><div class="sb-k">E-field</div><div class="sb-v g" id="sb-efield">Coro+VS(Kp)</div></div>
    <div class="sb-row"><div class="sb-k">Temporal mode</div><div class="sb-v" id="sb-temporal">TIME SERIES</div></div>
    <div class="sb-row"><div class="sb-k">Spectrum</div><div class="sb-v" id="sb-spec-type">POWER LAW</div></div>
    <div class="sb-row"><div class="sb-k">Output mode</div><div class="sb-v" id="sb-output-mode">TRAJECTORY</div></div>
  </div>
  <div class="sb-card">
    <div class="sb-title">Compute Estimate</div>
    <div class="sb-row"><div class="sb-k">Est. queue wait</div><div class="sb-v o" id="est-queue">4‚Äì8 hours</div></div>
    <div class="sb-row"><div class="sb-k">Compute cost</div><div class="sb-v o" id="est-sbu">~5,000 SBU</div></div>
    <div class="sb-row"><div class="sb-k">Output size</div><div class="sb-v" id="est-output">~5.6 GB</div></div>
  </div>
  <div class="sb-card">
    <div class="sb-title">TS05 Storm Params</div>
    <div class="sb-row"><div class="sb-k">Dst</div><div class="sb-v r">‚àí142 nT</div></div>
    <div class="sb-row"><div class="sb-k">Pdyn</div><div class="sb-v">3.5 nPa</div></div>
    <div class="sb-row"><div class="sb-k">IMF Bz</div><div class="sb-v r">‚àí18.5 nT</div></div>
    <div class="sb-row"><div class="sb-k">Shue r‚ÇÄ</div><div class="sb-v g">8.56 RE</div></div>
  </div>
  <div class="sb-card">
    <div class="sb-title">AMPS_PARAM.in Preview</div>
    <pre id="sb-param-preview" style="font-family:var(--font-mono);font-size:9px;color:var(--text-dim);overflow:hidden;max-height:140px;white-space:pre-wrap;line-height:1.6;">#BACKGROUND_FIELD
FIELD_MODEL     TS05
TS05_DST        -142.0
TS05_PDYN       3.50
BOUNDARY_TYPE   SHUE
SHUE_R0         AUTO
TEMPORAL_MODE   TIME_SERIES</pre>
  </div>
</div>

</div>

<div class="submit-bar">
  <button class="btn-secondary" id="btn-prev" onclick="prevStep()" disabled>&#8592; Previous</button>
  <button class="btn-primary" id="btn-next" onclick="nextStep()">Next Step &#8594;</button>
  <button class="btn-primary" id="btn-submit" style="display:none;" onclick="goToReview()">&#128203; Review &amp; Submit</button>
  <div class="run-est">
    <span>Est. queue: <b id="est-queue">4&#8211;8 h</b></span>
    <span>Compute: <b id="est-sbu">~5,000 SBU</b></span>
    <span>Output: <b id="est-output">~5.6 GB</b></span>
  </div>
</div>
</div>
</div>


<div id="submit-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:300;align-items:center;justify-content:center;">
  <div style="background:var(--bg-panel);border:1px solid var(--green);border-radius:var(--radius-xl);padding:36px;max-width:520px;width:92%;text-align:center;">
    <div style="font-size:52px;margin-bottom:16px;">&#128640;</div>
    <h2 style="color:var(--green);margin-bottom:8px;">Run Submitted!</h2>
    <p style="color:var(--text-dim);margin-bottom:14px;font-size:13px;line-height:1.7;">Your run has been queued at CCMC.<br>
    Estimated queue wait: <b style="color:var(--orange)">1&#8211;3 business days</b><br>
    Compute cost: <b style="color:var(--orange)">~5,000 SBU</b></p>
    <p style="font-size:11px;color:var(--text-muted);">Confirmation will be sent to your PI email. You can track status at <a href="https://ccmc.gsfc.nasa.gov" style="color:var(--accent);">ccmc.gsfc.nasa.gov</a>.</p>
    <button class="btn-primary" style="margin-top:20px;" onclick="document.getElementById('submit-modal').style.display='none'">Close</button>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê JavaScript modules ‚Äî load order matters ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- 1. State object & shared constants (no dependencies) -->
<script src="js/01-state.js"></script>
<!-- 2. Wizard navigation (depends on: state) -->
<script src="js/02-wizard.js"></script>
<!-- 3. Run info, particle, background field (depends on: state, wizard) -->
<script src="js/03-bgfield.js"></script>
<!-- 4. Domain boundary + SVG diagrams (depends on: state) -->
<script src="js/04-boundary.js"></script>
<!-- 5. Electric field model (depends on: state) -->
<script src="js/05-efield.js"></script>
<!-- 6. Temporal variability (depends on: state) -->
<script src="js/06-temporal.js"></script>
<!-- 7. Spectrum canvas + output options (depends on: state) -->
<script src="js/07-spectrum-output.js"></script>
<!-- 8. Review, param-file builder, sidebar (depends on: all above) -->
<script src="js/08-review.js"></script>
<!-- 9. Init ‚Äî boot sequence (must be last) -->
<script src="js/09-init.js"></script>

<script src="js/10-help.js"></script>
<script src="js/11-docs.js"></script>
</body>
</html>
